---
title: "Untitled"
output: html_document
---


# Load libraries



```{r, warning = F, message = F}

library(tidyverse); library(haven); library(lubridate);
library(knitr); library(kableExtra);
library(Hmisc); library(survey)
library(expss); library(here); library(gmodels)
library(flextable); library(formattable)
library(prettydoc); library(officer)

library(tableone); library(sjPlot); 

```


# WS 1.4


```{r}



hl <- read_sav(here("Data/Tunisia_hl.sav")) %>% arrange(HH1, HH2, HL1)

hh <- read_sav(here("Data/Tunisia_hh.sav")) %>% arrange(HH1, HH2)

```


```{r}


hl <- hl %>% mutate(elevel = ifelse(ED5A %in% c(3:4), 3,
                                  ifelse(ED5A %in% c(8:9), 9,
                                         0)))

var_lab(hl$elevel) = "Education"
val_lab(hl$elevel) = make_labels("
  0 None/ECE
  1 Primary
  2 Lower secondary
  3 Upper secondary or higher  
  9 DK/Missing                                
                       
                                 ")
  
  

tmp.person.cwater = hl %>% select(HH1, HH2, HL1, HL4, HL6, elevel) %>% rename(WS5 = HL1)



```



Merge the person collecting the water with the household file. 

```{r}


df = hh %>% left_join(tmp.person.cwater, by = c("HH1", "HH2", "WS5")) %>% 
  filter(HH46 == 1, WS4 > 0) %>% 
  mutate(hhweightHH48 = HH48 * hhweight) %>%
  mutate(nhhmem = hhweightHH48)


var_lab(df$nhhmem) = "Number of household members without drinking water on premises and where household members are primarily responsible for collecting water"


df <- df %>% 
  mutate(Time = NA) %>% 
  mutate(Time = ifelse(WS4 < 995 & WS6 < 95, floor(WS4 * WS6 / 7), Time)) %>% 
  mutate(Time = ifelse(Time %in% 0:30, 1,
                       ifelse(Time %in% 31:60, 2,
                              ifelse(Time %in% 61:180, 3,
                                     ifelse(Time %in% c(181, max(df$Time)), 4, Time)))))

df <- df %>% mutate(averagetime = Time) %>% 
  mutate(averagetime = ifelse(WS4 > 995 | WS6 > 95, 9, averagetime))


df <- df %>% mutate(age1 = ifelse(HL6 %in% 0:14, 1,
                                  ifelse(HL6 %in% 15:49, 3,
                                         ifelse(HL6 %in% 50:95, 4, 9))))

var_lab(df$age1) = "Age"

df = df %>% mutate(age2 = ifelse(HL6 %in% 15:17, 2, age1))

val_lab(df$age1) = make_labels("
1 <15
2 5-14
3 15-49
4 50+
9 DK/Missing
             ")



```


```{r}

source(here("R/drinkingWater.R"))


 

```


# WS 1.5

```{r}



hl <- read_sav(here("Data/Tunisia_hl.sav")) %>% arrange(HH1, HH2, HL1)

hh <- read_sav(here("Data/Tunisia_hh.sav")) %>% filter(HH46 == 1) %>%
  mutate(nhhmem = HH48 * hhweight)


var_lab(hh$nhhmem) = "Number of household members"

source(here("R/drinkingWater.R"))


hh <- hh %>% mutate(sufficentwater = 0) %>% 
  mutate(sufficentwater = ifelse(WS7 == 2, 100, sufficentwater))

var_lab(hh$sufficentwater) = "Percentage of household population with drinking water available in sufficient quantities [1]"


hh <- hh %>% mutate(nmemnotsufficent = ifelse(!is.na(WS8), 1, 0))


var_lab(hh$nmemnotsufficent) = "Number of household members unable to access water in sufficient quantities when needed"

hh <- hh %>% mutate(WS8 = ifelse(WS8 == 8, 9, WS8)); 
val_lab(hh$WS8) = make_labels("
                              9 DK/Missing
                              ")

var_lab(hh$WS8) = "Main reason that the household members are unable to access water in sufficient quantities"

```





# WS 1.6

E. Coli

```{r}



hh <- read_sav(here("Data/Tunisia_hh.sav")) %>% arrange(HH1, HH2) %>% 
  filter(WQ31 == 1) %>% 
  mutate(wqsweightHH48 = 0) %>% 
  mutate(wqsweightHH48 = ifelse(wqsweight > 0, wqsweight * HH48, wqsweightHH48)) %>% 
  mutate(nhhmem = wqsweightHH48)

var_lab(hh$nhhmem) = "Number of household members"


hh <- hh %>% mutate(EC_100_S = NA) %>% 
  mutate(EC_100_S = ifelse(WQ27 < 997 & WQ27 >= 100, 101,
                           ifelse(WQ27 < 101 | WQ27 >= 997, WQ27, EC_100_S)))

hh <- hh %>% mutate(Risk_S = ifelse(EC_100_S %in% 1:10, 1,
                                      ifelse(EC_100_S %in% 11:100, 2,
                                             ifelse(EC_100_S == 101, 3,
                                                    ifelse(EC_100_S >= 102, 9, EC_100_S)))))


var_lab(hh$Risk_S) = "Risk level based on number of E. coli per 100 mL"
val_lab(hh$Risk_S) = make_labels("
                                 0 Low (<1 per 100 mL)
                                 1 Moderate (1-10 per 100 mL)
                                 2 High (11-100 per 100 mL)
                                 3 Very high (>100 per 100 mL)
                                 9 DK/Missing
                                 ")


hh <- hh %>% mutate(EC_S = 0) %>% mutate(EC_S = ifelse(!Risk_S == 0, 100, 0))
var_lab(hh$EC_S) = "Percentage of household population with  E. coli in source water [1]"


hh <- hh %>% filter(Risk_S <= 3)


hh <- hh %>%
  mutate(impdrinkingWaterSource = ifelse(WS1 %in% 11:14, 11,
                                                    ifelse(WS1 == 21, 12,
                                                           ifelse(WS1 %in% c(31, 41), 13,
                                                                  ifelse(WS1 == 51, 14,
                                                                         ifelse(WS1 == 72, 15,
                                                                                ifelse(WS1 %in% c(61, 71), 16,
                                                                                       ifelse(WS1 %in% 91:92, 17, WS1)))))))) # else WS1?

hh = hh %>% mutate(unimpdrinkingWaterSource = ifelse(WS1 %in% c(32, 42), 21, 22))




hh <- hh %>% mutate(watersource = ifelse(impdrinkingWaterSource %in% 11:17, 10, 
                                         ifelse(unimpdrinkingWaterSource %in% 21:22, 20, NA)))


val_lab(hh$watersource) = make_labels("
  10 Improved sources
  11 Piped water
  12 Tubewell/Borehole
  13 Protected well or spring
  14 Rainwater collection
  15 Water kiosk	  				 
  16 Tanker-truck/Cart will small tank
  17 Bottled/Sachet water
  20 Unimproved sources
  21 Unprotected well or spring
  22 Surface water/Other
                                      ")










```

(come back around to tables all at once to attempt automation / function wrappers etc)


# WS 1.7


```{r}

hh <- read_sav(here("Data/Tunisia_hh.sav")) %>% arrange(HH1, HH2) %>% 
  filter(WQ31 == 1) %>% 
  mutate(wqhweightHH48 = 0) %>% 
  mutate(wqhweightHH48 = ifelse(wqhweight > 0, wqhweight * HH48, wqhweightHH48)) %>% 
  mutate(nhhmem = wqhweightHH48)







hh <- hh %>% mutate(EC_100_H = NA) %>%
  mutate(EC_100_H = ifelse(WQ26 < 998 & WQ26 >= 100, 101,
                           ifelse(WQ26 < 101 | WQ26 >= 997, WQ26, EC_100_H)))




hh <- hh %>% mutate(Risk_H = ifelse(EC_100_H %in% 1:10, 1,
                                    ifelse(EC_100_H %in% 11:100, 2,
                                           ifelse(EC_100_H == 101, 3,
                                                  ifelse(EC_100_H >= 102, 9, EC_100_H)))))


var_lab(hh$EC_100_H) = "Risk level based on number of E. coli per 100 mL"
val_lab(hh$EC_100_H) = make_labels("
                                   0 Low (<1 per 100 mL) 
                                   1 Moderate (1-10 per 100 mL) 
                                   2 High (11-100 per 100 mL) 
                                   3 Very high (>100 per 100 mL) 
                                   9 DK/Missing
                                   ")



hh = hh %>% mutate(EC_H = 0) %>% 
  mutate(EC_H = ifelse(!Risk_H == 0, 100, EC_H))

var_lab(hh$EC_H) = "Percentage of household population with  E. coli in household drinking water [1]"


hh = hh %>% filter(Risk_H <= 3)


hh <- hh %>% mutate(impdrinkingWaterSource = ifelse())





hh <- hh %>%
  mutate(impdrinkingWaterSource = ifelse(WS1 %in% 11:14, 11,
                                                    ifelse(WS1 == 21, 12,
                                                           ifelse(WS1 %in% c(31, 41), 13,
                                                                  ifelse(WS1 == 51, 14,
                                                                         ifelse(WS1 == 72, 15,
                                                                                ifelse(WS1 %in% c(61, 71), 16,
                                                                                       ifelse(WS1 %in% 91:92, 17, WS1)))))))) # else WS1?

hh = hh %>% mutate(unimpdrinkingWaterSource = ifelse(WS1 %in% c(32, 42), 21, 22))




hh <- hh %>% mutate(watersource = ifelse(impdrinkingWaterSource %in% 11:17, 10, 
                                         ifelse(unimpdrinkingWaterSource %in% 21:22, 20, NA)))



val_lab(hh$watersource) = make_labels("
  10 Improved sources
  11 Piped water
  12 Tubewell/Borehole
  13 Protected well or spring
  14 Rainwater collection
  15 Water kiosk	  				 
  16 Tanker-truck/Cart will small tank
  17 Bottled/Sachet water
  20 Unimproved sources
  21 Unprotected well or spring
  22 Surface water/Other
                                      ")







```



