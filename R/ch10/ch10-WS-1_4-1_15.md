Chapter 10 - WS 1.4 - WS 4.2
================

# Load libraries

``` r
library(tidyverse); library(haven); library(lubridate);
library(knitr); library(kableExtra);
library(Hmisc); library(survey)
library(expss); library(here); library(gmodels)
library(flextable); library(formattable)
library(prettydoc); library(officer)

library(tableone); library(sjPlot); 
```

# WS 1.4

Merge the person collecting the water with the household file.

``` r
hl <- read_sav(here("Data/Tunisia_hl.sav")) %>% arrange(HH1, HH2, HL1)

hh <- read_sav(here("Data/Tunisia_hh.sav")) %>% arrange(HH1, HH2)


hl <- hl %>% 
  mutate(elevel = ifelse(ED5A == 1, 1,
                         ifelse(ED5A == 2, 2,
                                ifelse(ED5A %in% 3:4, 3,
                                       ifelse(ED5A %in% 8:9, 9, 0)))))

var_lab(hl$elevel) = "Education"
val_lab(hl$elevel) = make_labels("
  0 None/ECE
  1 Primary
  2 Lower secondary
  3 Upper secondary or higher  
  9 DK/Missing                                
                       
                                 ")
  
  

tmp.person.cwater = hl %>% select(HH1, HH2, HL1, HL4, HL6, elevel) %>% rename(WS5 = HL1)



hh = hh %>% left_join(tmp.person.cwater, by = c("HH1", "HH2", "WS5")) %>% 
  filter(HH46 == 1, WS4 > 0) %>% 
  mutate(hhweightHH48 = HH48 * hhweight) %>%
  mutate(nhhmem = hhweightHH48)


var_lab(hh$nhhmem) = "Number of household members without drinking water on premises and where household members are primarily responsible for collecting water"


hh <- hh %>% 
  mutate(Time = NA) %>% 
  mutate(Time = ifelse(WS4 < 995 & WS6 < 95, floor(WS4 * WS6 / 7), Time)) %>% 
  mutate(Time = ifelse(Time %in% 0:30, 1,
                       ifelse(Time %in% 31:60, 2,
                              ifelse(Time %in% 61:180, 3,
                                     ifelse(Time >= 181, 4, Time)))))

hh <- hh %>% mutate(averagetime = Time) %>% 
  mutate(averagetime = ifelse(WS4 > 995 | WS6 > 95, 9, averagetime))


hh <- hh %>% mutate(age1 = ifelse(HL6 %in% 0:14, 1,
                                  ifelse(HL6 %in% 15:49, 3,
                                         ifelse(HL6 %in% 50:95, 4, 9)))) # age age1



hh = hh %>% mutate(age2 = ifelse(HL6 %in% 15:17, 2, NA))

var_lab(hh$age1) = "Age"; var_lab(hh$age2) = "Age"





val_lab(hh$age1) = make_labels("
1 <15
2 15-17
3 15-49
4 50+
             ")
val_lab(hh$age2) = make_labels("

2 15-49

             ")

val_lab(hh$averagetime) = make_labels("
    1 Up to 30 minutes
    2 From 31 mins to 1 hour
    3 Over 1 hour to 3 hours
    4 Over 3 hours
    9 DK/Missing
                                      ")



source(here("R/drinkingWater.R"))


hh$nn = 1
```

Table functions successful\!

## SFR 1.4

``` r
row.vars = list(total(), hh$HH6, hh$HH7, hh$elevel, mrset(hh$age1, hh$age2), hh$HL4, hh$drinkingWater, hh$windex5)
col.vars = list(hh$averagetime, total())
hh.weight = hh$nhhmem
cell.vars = hh$nn

a = calc_cro_rpct(hh,
    cell_vars = cell.vars,
    col_vars = col.vars,
    row_vars = row.vars,
    weight = hh.weight,
    total_row_position = "none") %>% data.frame() %>% select(-1)


b = calc_cro_cases(
    hh,
    cell_vars = cell.vars,
    row_vars = row.vars,
    col_vars = total(),
    weight = nhhmem,
    total_row_position = "none"
  ) %>% data.frame() %>%  select(2)



unweighted <- calc_cro_cases(
    hh,
    cell_vars = nn,
    row_vars = row.vars,
    col_vars = total(),
    total_row_position = "none"
  ) %>% data.frame() %>% select(2) %>% 
  mutate(ind = ifelse(X.Total < 25, 1, 
               ifelse(X.Total %in% 25:49, 2,
                      3)))


a = round(a, digits = 1); b = round(b, digits = 0)

tab = a %>% cbind.data.frame(b) 
tab = tab[, -4]



tab = lapply(tab, function(x) ifelse(is.na(x), 0, x)) %>% data.frame()



colnames(tab) = c(levels(as_factor(hh$averagetime))[c(1:4)], "Total", label(hh$nhhmem))

rownames(tab) = c("Total", levels(as_factor(hh$HH6)), levels(as_factor(hh$HH7)),
                   levels(as_factor(hh$elevel)), levels(as_factor(hh$age1)),
                   levels(as_factor(hh$HL4)), levels(as_factor(hh$drinkingWater)),
                   levels(as_factor(hh$windex5)))





for (i in 1:nrow(tab)) 
  for (j in 1:ncol(tab)) 
  {
    tab[i, j] = ifelse(unweighted$ind[i] == 1, "(*)", 
                       ifelse(unweighted$ind[i] == 2, paste0("(", tab[i,j], ")"),
                              tab[i, j])) # else
  }




tab %>% 
  kable(digits = 1, format.args = list(big.mark = ",", scientific = FALSE)) %>% 
  kable_styling(c("striped"), font_size = 12) %>% 
  pack_rows(label(hh$HH6), 2, 3) %>% 
  pack_rows(label(hh$HH7), 4, 10) %>% 
  pack_rows(label(hh$elevel), 11, 15) %>%
  pack_rows(label(hh$age1), 16, 19) %>% 
  pack_rows(label(hh$HL4), 20, 21) %>% 
  pack_rows(label(hh$drinkingWater), 22, 23) %>% 
  pack_rows(label(hh$windex5), 24, 28) %>% 
  add_header_above(c(" " = 1, "Average time spent collecting water per day" = 4, 
                     " " = 2)) %>% 
  add_header_above(c("Table 1.4: Time spent collecting water" = 7)) 
```

<table class="table table-striped" style="font-size: 12px; margin-left: auto; margin-right: auto;">

<thead>

<tr>

<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="7">

<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">

Table 1.4: Time spent collecting water

</div>

</th>

</tr>

<tr>

<th style="border-bottom:hidden" colspan="1">

</th>

<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="4">

<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">

Average time spent collecting water per day

</div>

</th>

<th style="border-bottom:hidden" colspan="2">

</th>

</tr>

<tr>

<th style="text-align:left;">

</th>

<th style="text-align:left;">

Up to 30 minutes

</th>

<th style="text-align:left;">

From 31 mins to 1 hour

</th>

<th style="text-align:left;">

Over 1 hour to 3 hours

</th>

<th style="text-align:left;">

Over 3 hours

</th>

<th style="text-align:left;">

Total

</th>

<th style="text-align:left;">

Number of household members without drinking water on premises and where
household members are primarily responsible for collecting water

</th>

</tr>

</thead>

<tbody>

<tr>

<td style="text-align:left;">

Total

</td>

<td style="text-align:left;">

92.7

</td>

<td style="text-align:left;">

1.2

</td>

<td style="text-align:left;">

0.5

</td>

<td style="text-align:left;">

5.7

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

3964

</td>

</tr>

<tr grouplength="2">

<td colspan="7" style="border-bottom: 1px solid;">

<strong>Area</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

URBAIN

</td>

<td style="text-align:left;">

93.8

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

6.2

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

1457

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

RURAL

</td>

<td style="text-align:left;">

92

</td>

<td style="text-align:left;">

1.8

</td>

<td style="text-align:left;">

0.8

</td>

<td style="text-align:left;">

5.4

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

2508

</td>

</tr>

<tr grouplength="7">

<td colspan="7" style="border-bottom: 1px solid;">

<strong>Region</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

DISTRICT TUNIS

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

NORD EST

</td>

<td style="text-align:left;">

(94.3)

</td>

<td style="text-align:left;">

0)  
    
    </td>
    
    <td style="text-align:left;">
    
    0)  
        
        </td>
        
        <td style="text-align:left;">
        
        (5.7)
        
        </td>
        
        <td style="text-align:left;">
        
        100) 
             
             </td>
             
             <td style="text-align:left;">
             
             179) 
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  NORD OUEST
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  95.2
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  0.8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  0.9
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  3
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  1036
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  CENTRE EST
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  92.5
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  0.5
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  0
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  7
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  1105
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  CENTRE OUEST
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  92.2
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  2.6
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  1
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  4.3
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  1116
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  SUD EST
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  89.4
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  0
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  0
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  10.6
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  352
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  SUD OUEST
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  (73.1)
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  (2.8)
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  0)  
                      
                      </td>
                      
                      <td style="text-align:left;">
                      
                      (24.1)
                      
                      </td>
                      
                      <td style="text-align:left;">
                      
                      100) 
                           
                           </td>
                           
                           <td style="text-align:left;">
                           
                           90) 
                               
                               </td>
                               
                               </tr>
                               
                               <tr grouplength="5">
                               
                               <td colspan="7" style="border-bottom: 1px solid;">
                               
                               <strong>Education</strong>
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               None/ECE
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               Primary
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               91.1
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               1.4
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.4
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               7.1
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               1494
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               Lower secondary
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               89.3
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               2.6
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               8.2
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               401
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               Upper secondary or higher
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               92.1
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.6
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.8
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               6.5
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               934
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               DK/Missing
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               </tr>
                               
                               <tr grouplength="4">
                               
                               <td colspan="7" style="border-bottom: 1px solid;">
                               
                               <strong>Age</strong>
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               \<15
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               15-17
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (\*)
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               15-49
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               93.1
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               1.2
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.6
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               5.1
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               2478
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               50+
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               92.3
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.8
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.4
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               6.5
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               1399
                               
                               </td>
                               
                               </tr>
                               
                               <tr grouplength="2">
                               
                               <td colspan="7" style="border-bottom: 1px solid;">
                               
                               <strong>Sex</strong>
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               MALE
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               91.8
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.9
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.3
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               7
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               2069
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               FEMALE
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               93.6
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               1.4
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.7
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               4.3
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               1895
                               
                               </td>
                               
                               </tr>
                               
                               <tr grouplength="2">
                               
                               <td colspan="7" style="border-bottom: 1px solid;">
                               
                               <strong>Source of drinking water</strong>
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               Improved
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               92.7
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               1.2
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.5
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               5.7
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               3573
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               Unimproved
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               92.6
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.8
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.9
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               5.8
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               391
                               
                               </td>
                               
                               </tr>
                               
                               <tr grouplength="5">
                               
                               <td colspan="7" style="border-bottom: 1px solid;">
                               
                               <strong>Wealth index quintile</strong>
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               Poorest
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               92.2
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               2
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.8
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               5
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               2301
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               Second
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               93.7
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0.2
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               6.2
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               1022
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               Middle
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               92.8
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               7.2
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               100
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               483
                               
                               </td>
                               
                               </tr>
                               
                               <tr>
                               
                               <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                               
                               Fourth
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               (90.4)
                               
                               </td>
                               
                               <td style="text-align:left;">
                               
                               0)  
                                   
                                   </td>
                                   
                                   <td style="text-align:left;">
                                   
                                   0)  
                                       
                                       </td>
                                       
                                       <td style="text-align:left;">
                                       
                                       (9.6)
                                       
                                       </td>
                                       
                                       <td style="text-align:left;">
                                       
                                       100) 
                                            
                                            </td>
                                            
                                            <td style="text-align:left;">
                                            
                                            103) 
                                                 
                                                 </td>
                                                 
                                                 </tr>
                                                 
                                                 <tr>
                                                 
                                                 <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                                                 
                                                 Richest
                                                 
                                                 </td>
                                                 
                                                 <td style="text-align:left;">
                                                 
                                                 (\*)
                                                 
                                                 </td>
                                                 
                                                 <td style="text-align:left;">
                                                 
                                                 (\*)
                                                 
                                                 </td>
                                                 
                                                 <td style="text-align:left;">
                                                 
                                                 (\*)
                                                 
                                                 </td>
                                                 
                                                 <td style="text-align:left;">
                                                 
                                                 (\*)
                                                 
                                                 </td>
                                                 
                                                 <td style="text-align:left;">
                                                 
                                                 (\*)
                                                 
                                                 </td>
                                                 
                                                 <td style="text-align:left;">
                                                 
                                                 (\*)
                                                 
                                                 </td>
                                                 
                                                 </tr>
                                                 
                                                 </tbody>
                                                 
                                                 </table>

# WS 1.5

``` r
hl <- read_sav(here("Data/Tunisia_hl.sav")) %>% arrange(HH1, HH2, HL1)

hh <- read_sav(here("Data/Tunisia_hh.sav")) %>% filter(HH46 == 1) %>%
  mutate(nhhmem = HH48 * hhweight)


var_lab(hh$nhhmem) = "Number of household members"

source(here("R/drinkingWater.R"))


hh <- hh %>% mutate(sufficentwater = 0) %>% 
  mutate(sufficentwater = ifelse(WS7 == 2, 100, sufficentwater))

var_lab(hh$sufficentwater) = "Percentage of household population with drinking water available in sufficient quantities [1]"


hh <- hh %>% mutate(nmemnotsufficent = ifelse(!is.na(WS8), 1, 0))


var_lab(hh$nmemnotsufficent) = "Number of household members unable to access water in sufficient quantities when needed"

hh <- hh %>% mutate(WS8 = ifelse(WS8 == 8, 9, WS8)); 
val_lab(hh$WS8) = make_labels("
1 EAU NON DISSPONIBLE A LA SOURCE
3 SOURCE PAS ACCESSIBLE
6 AUTRE

                              9 DK/Missing
                              ")

var_lab(hh$WS8) = "Main reason that the household members are unable to access water in sufficient quantities"
```

## SFR 1.5

``` r
hh$nn = 1






row.vars = list(total(), hh$HH6, hh$HH7, hh$helevel, hh$drinkingWater, hh$windex5)
col.vars = list(hh$sufficentwater, hh$WS8, hh$nmemnotsufficent, total())
hh.weight = hh$nhhmem
cell.vars = hh$nn



taba = calc_cro_rpct(hh, cell_vars = total(),
               row_vars = row.vars, col_vars = hh$sufficentwater, 
               weight = hh.weight, total_row_position = "none") %>% data.frame() %>% select(3) %>% round(digits = 1)

tabb = calc_cro_cases(hh,
                   cell_vars = cell.vars, row_vars = row.vars, 
                   col_vars = total(), weight = hh.weight, total_row_position = "none") %>% data.frame() %>% select(2) %>% round(digits = 0)

tabc = calc_cro_rpct(hh,
                  cell_vars = cell.vars, 
                  row_vars = row.vars, 
                  col_vars = list(hh$WS8, total()),
                  weight = hh.weight, total_row_position = "none") %>% data.frame() %>% select(-1) %>% round(digits = 1)

tabd = calc_cro_cases(hh, cell_vars = cell.vars, row_vars = row.vars, col_vars = hh$nmemnotsufficent,
                      weight = hh.weight, total_row_position = "none") %>% data.frame() %>% select(3) %>% round(digits = 0)


tab = taba %>% cbind(tabb, tabc, tabd)



unweighted <- calc_cro_cases(
    hh,
    cell_vars = nn,
    row_vars = row.vars,
    col_vars = total(),
    total_row_position = "none"
  ) %>% data.frame() %>% select(2) %>% 
  mutate(ind = ifelse(X.Total < 25, 1, 
               ifelse(X.Total %in% 25:49, 2,
                      3)))



# tab = lapply(tab, function(x) ifelse(is.na(x), 0, x)) %>% data.frame()



colnames(tab) = c(label(hh$sufficentwater), label(hh$nhhmem), levels(as_factor(hh$WS8)), "total", label(hh$nmemnotsufficent))

rownames(tab) = c("Total", levels(as_factor(hh$HH6)), levels(as_factor(hh$HH7)),
                   levels(as_factor(hh$helevel)), levels(as_factor(hh$drinkingWater)),
                   levels(as_factor(hh$windex5)))





for (i in 1:nrow(tab)) 
  for (j in 1:ncol(tab)) 
  {
    tab[i, j] = ifelse(unweighted$ind[i] == 1, "(*)", 
                       ifelse(unweighted$ind[i] == 2, paste0("(", tab[i,j], ")"),
                              tab[i, j])) # else
  }




tab %>% 
  kable(digits = 1, format.args = list(big.mark = ",", scientific = FALSE)) %>% 
  kable_styling(c("striped"), font_size = 12) %>% 
  pack_rows(label(hh$HH6), 2, 3) %>% 
  pack_rows(label(hh$HH7), 4, 10) %>% 
  pack_rows(label(hh$helevel), 11, 15) %>%
  pack_rows(label(hh$drinkingWater), 16, 17) %>% 
  pack_rows(label(hh$windex5), 18, 22) %>% 
  add_header_above(c(" " = 3, "Main reason that the household members are unable to access water in sufficient quantities" = 5, " " = 1)) %>% 
  add_header_above(c("Table WS 1.5: Availability of sufficient drinking water when needed \n Percentage of household members with drinking water
                   available when needed and percent distribution of the main reasons 
                   household members unable to access water in suficient quantities when needed" = 9))
```

<table class="table table-striped" style="font-size: 12px; margin-left: auto; margin-right: auto;">

<thead>

<tr>

<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="9">

<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">

Table WS 1.5: Availability of sufficient drinking water when needed <br>
Percentage of household members with drinking water<br> available when
needed and percent distribution of the main reasons <br> household
members unable to access water in suficient quantities when needed

</div>

</th>

</tr>

<tr>

<th style="border-bottom:hidden" colspan="3">

</th>

<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="5">

<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">

Main reason that the household members are unable to access water in
sufficient quantities

</div>

</th>

<th style="border-bottom:hidden" colspan="1">

</th>

</tr>

<tr>

<th style="text-align:left;">

</th>

<th style="text-align:left;">

Percentage of household population with drinking water available in
sufficient quantities \[1\]

</th>

<th style="text-align:left;">

Number of household members

</th>

<th style="text-align:left;">

EAU NON DISSPONIBLE A LA SOURCE

</th>

<th style="text-align:left;">

SOURCE PAS ACCESSIBLE

</th>

<th style="text-align:left;">

AUTRE

</th>

<th style="text-align:left;">

DK/Missing

</th>

<th style="text-align:left;">

total

</th>

<th style="text-align:left;">

Number of household members unable to access water in sufficient
quantities when needed

</th>

</tr>

</thead>

<tbody>

<tr>

<td style="text-align:left;">

Total

</td>

<td style="text-align:left;">

80.6

</td>

<td style="text-align:left;">

43638

</td>

<td style="text-align:left;">

77

</td>

<td style="text-align:left;">

6.8

</td>

<td style="text-align:left;">

6.4

</td>

<td style="text-align:left;">

9.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

8199

</td>

</tr>

<tr grouplength="2">

<td colspan="9" style="border-bottom: 1px solid;">

<strong>Area</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

URBAIN

</td>

<td style="text-align:left;">

83.4

</td>

<td style="text-align:left;">

29853

</td>

<td style="text-align:left;">

75.4

</td>

<td style="text-align:left;">

5.2

</td>

<td style="text-align:left;">

6.9

</td>

<td style="text-align:left;">

12.4

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

4759

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

RURAL

</td>

<td style="text-align:left;">

74.5

</td>

<td style="text-align:left;">

13785

</td>

<td style="text-align:left;">

79.1

</td>

<td style="text-align:left;">

9

</td>

<td style="text-align:left;">

5.7

</td>

<td style="text-align:left;">

6.2

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

3441

</td>

</tr>

<tr grouplength="7">

<td colspan="9" style="border-bottom: 1px solid;">

<strong>Region</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

DISTRICT TUNIS

</td>

<td style="text-align:left;">

89

</td>

<td style="text-align:left;">

10398

</td>

<td style="text-align:left;">

56.4

</td>

<td style="text-align:left;">

9.8

</td>

<td style="text-align:left;">

6

</td>

<td style="text-align:left;">

27.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

1097

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

NORD EST

</td>

<td style="text-align:left;">

76.5

</td>

<td style="text-align:left;">

6146

</td>

<td style="text-align:left;">

87.3

</td>

<td style="text-align:left;">

2.5

</td>

<td style="text-align:left;">

4.7

</td>

<td style="text-align:left;">

5.4

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

1393

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

NORD OUEST

</td>

<td style="text-align:left;">

75.3

</td>

<td style="text-align:left;">

4777

</td>

<td style="text-align:left;">

71.1

</td>

<td style="text-align:left;">

13.9

</td>

<td style="text-align:left;">

8.6

</td>

<td style="text-align:left;">

6.4

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

1150

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

CENTRE EST

</td>

<td style="text-align:left;">

75.4

</td>

<td style="text-align:left;">

10289

</td>

<td style="text-align:left;">

84.2

</td>

<td style="text-align:left;">

4.2

</td>

<td style="text-align:left;">

7.7

</td>

<td style="text-align:left;">

3.9

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

2513

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

CENTRE OUEST

</td>

<td style="text-align:left;">

82.2

</td>

<td style="text-align:left;">

5584

</td>

<td style="text-align:left;">

62.8

</td>

<td style="text-align:left;">

12.4

</td>

<td style="text-align:left;">

8.7

</td>

<td style="text-align:left;">

16.1

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

944

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

SUD EST

</td>

<td style="text-align:left;">

87.7

</td>

<td style="text-align:left;">

3957

</td>

<td style="text-align:left;">

97.4

</td>

<td style="text-align:left;">

0.6

</td>

<td style="text-align:left;">

1.2

</td>

<td style="text-align:left;">

0.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

476

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

SUD OUEST

</td>

<td style="text-align:left;">

72.6

</td>

<td style="text-align:left;">

2486

</td>

<td style="text-align:left;">

77.6

</td>

<td style="text-align:left;">

5.2

</td>

<td style="text-align:left;">

1.8

</td>

<td style="text-align:left;">

15.3

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

625

</td>

</tr>

<tr grouplength="5">

<td colspan="9" style="border-bottom: 1px solid;">

<strong>Education of household head</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Pre-primary or none

</td>

<td style="text-align:left;">

76.8

</td>

<td style="text-align:left;">

7899

</td>

<td style="text-align:left;">

80.7

</td>

<td style="text-align:left;">

5.7

</td>

<td style="text-align:left;">

4.3

</td>

<td style="text-align:left;">

9.4

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

1778

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Primary

</td>

<td style="text-align:left;">

78.5

</td>

<td style="text-align:left;">

16191

</td>

<td style="text-align:left;">

77.2

</td>

<td style="text-align:left;">

8.1

</td>

<td style="text-align:left;">

6.7

</td>

<td style="text-align:left;">

8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

3391

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Secondary

</td>

<td style="text-align:left;">

82.7

</td>

<td style="text-align:left;">

14179

</td>

<td style="text-align:left;">

75

</td>

<td style="text-align:left;">

5.5

</td>

<td style="text-align:left;">

6.2

</td>

<td style="text-align:left;">

13.3

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

2369

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Higher

</td>

<td style="text-align:left;">

87

</td>

<td style="text-align:left;">

5294

</td>

<td style="text-align:left;">

72.2

</td>

<td style="text-align:left;">

8.6

</td>

<td style="text-align:left;">

11.5

</td>

<td style="text-align:left;">

7.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

646

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Missing/DK

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

</tr>

<tr grouplength="2">

<td colspan="9" style="border-bottom: 1px solid;">

<strong>Source of drinking water</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Improved

</td>

<td style="text-align:left;">

80.6

</td>

<td style="text-align:left;">

42768

</td>

<td style="text-align:left;">

77

</td>

<td style="text-align:left;">

6.7

</td>

<td style="text-align:left;">

6.4

</td>

<td style="text-align:left;">

9.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

8043

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Unimproved

</td>

<td style="text-align:left;">

81.2

</td>

<td style="text-align:left;">

870

</td>

<td style="text-align:left;">

73.6

</td>

<td style="text-align:left;">

13.6

</td>

<td style="text-align:left;">

3.3

</td>

<td style="text-align:left;">

9.5

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

157

</td>

</tr>

<tr grouplength="5">

<td colspan="9" style="border-bottom: 1px solid;">

<strong>Wealth index quintile</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Poorest

</td>

<td style="text-align:left;">

73

</td>

<td style="text-align:left;">

8728

</td>

<td style="text-align:left;">

80.2

</td>

<td style="text-align:left;">

10.1

</td>

<td style="text-align:left;">

6.4

</td>

<td style="text-align:left;">

3.4

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

2303

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Second

</td>

<td style="text-align:left;">

80.9

</td>

<td style="text-align:left;">

8727

</td>

<td style="text-align:left;">

79.6

</td>

<td style="text-align:left;">

6.6

</td>

<td style="text-align:left;">

5.9

</td>

<td style="text-align:left;">

7.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

1615

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Middle

</td>

<td style="text-align:left;">

79.2

</td>

<td style="text-align:left;">

8726

</td>

<td style="text-align:left;">

79.4

</td>

<td style="text-align:left;">

3.5

</td>

<td style="text-align:left;">

5.3

</td>

<td style="text-align:left;">

11.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

1772

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Fourth

</td>

<td style="text-align:left;">

81.7

</td>

<td style="text-align:left;">

8731

</td>

<td style="text-align:left;">

70.1

</td>

<td style="text-align:left;">

4.7

</td>

<td style="text-align:left;">

7

</td>

<td style="text-align:left;">

18.1

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

1534

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Richest

</td>

<td style="text-align:left;">

88.2

</td>

<td style="text-align:left;">

8725

</td>

<td style="text-align:left;">

71.5

</td>

<td style="text-align:left;">

8.7

</td>

<td style="text-align:left;">

8.1

</td>

<td style="text-align:left;">

11.7

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

975

</td>

</tr>

</tbody>

</table>

# WS 1.6

E. Coli

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav")) %>% arrange(HH1, HH2) %>% 
  filter(WQ31 == 1) %>% 
  mutate(wqsweightHH48 = 0) %>% 
  mutate(wqsweightHH48 = ifelse(wqsweight > 0, wqsweight * HH48, wqsweightHH48)) %>% 
  mutate(nhhmem = wqsweightHH48)

var_lab(hh$nhhmem) = "Number of household members"


hh <- hh %>% mutate(EC_100_S = NA) %>% 
  mutate(EC_100_S = ifelse(WQ27 < 997 & WQ27 >= 100, 101,
                           ifelse(WQ27 < 101 | WQ27 >= 997, WQ27, EC_100_S)))

hh <- hh %>% mutate(Risk_S = ifelse(EC_100_S %in% 1:10, 1,
                                      ifelse(EC_100_S %in% 11:100, 2,
                                             ifelse(EC_100_S == 101, 3,
                                                    ifelse(EC_100_S >= 102, 9, EC_100_S)))))




var_lab(hh$Risk_S) = "Risk level based on number of E. coli per 100 mL"
val_lab(hh$Risk_S) = make_labels("
                                 0 Low (<1 per 100 mL)
                                 1 Moderate (1-10 per 100 mL)
                                 2 High (11-100 per 100 mL)
                                 3 Very high (>100 per 100 mL)
                                 9 DK/Missing
                                 ")


hh <- hh %>% mutate(EC_S = 0) %>% mutate(EC_S = ifelse(!Risk_S == 0, 100, 0))
var_lab(hh$EC_S) = "Percentage of household population with  E. coli in source water [1]"


hh <- hh %>% filter(Risk_S <= 3)


hh <- hh %>%
  mutate(impdrinkingWaterSource = ifelse(WS1 %in% 11:14, 11,
                                                    ifelse(WS1 == 21, 12,
                                                           ifelse(WS1 %in% c(31, 41), 13,
                                                                  ifelse(WS1 == 51, 14,
                                                                         ifelse(WS1 == 72, 15,
                                                                                ifelse(WS1 %in% c(61, 71), 16,
                                                                                       ifelse(WS1 %in% 91:92, 17, WS1)))))))) # else WS1?

hh = hh %>% mutate(unimpdrinkingWaterSource = ifelse(WS1 %in% c(32, 42), 21, 22))




hh <- hh %>% mutate(watersource = ifelse(impdrinkingWaterSource %in% 11:17, 10, 
                                         ifelse(unimpdrinkingWaterSource %in% 21:22, 20, NA)))



var_lab(hh$watersource) = "Main source of drinking water[A]"
val_lab(hh$watersource) = make_labels("
  10 Improved sources
  11 Piped water
  12 Tubewell/Borehole
  13 Protected well or spring
  14 Rainwater collection
  15 Water kiosk                     
  16 Tanker-truck/Cart will small tank
  17 Bottled/Sachet water
  20 Unimproved sources
  21 Unprotected well or spring
  22 Surface water/Other
                                      ")
```

(come back around to tables all at once to attempt automation / function
wrappers etc)

## SFR 1.6

``` r
# mrset(hh$watersource, hh$impdrinkingWaterSource, hh$unimpdrinkingWaterSource)

hh$nn = 1


row.vars = list(total(), hh$HH6, hh$HH7, hh$helevel, mrset(hh$watersource, hh$impdrinkingWaterSource, hh$unimpdrinkingWaterSource),
                hh$windex5)

col.vars = list(hh$sufficentwater, hh$WS8, hh$nmemnotsufficent, total())
```

    ## Warning: Unknown or uninitialised column: `sufficentwater`.

    ## Warning: Unknown or uninitialised column: `nmemnotsufficent`.

``` r
hh.weight = hh$nhhmem
cell.vars = hh$nn



taba = calc_cro_rpct(hh, cell_vars = cell.vars,
               row_vars = row.vars, 
               col_vars = list(hh$Risk_S, total()), 
               weight = hh.weight, total_row_position = "none") %>% data.frame() %>% select(-1) %>% select(1:4, 6) %>% 
  slice(-c(27:30)) %>% round(digits = 1)



tabb = calc_cro_rpct(hh,
                   cell_vars = cell.vars, row_vars = row.vars, 
                   col_vars = hh$EC_S, weight = hh.weight, total_row_position = "none") %>% 
  data.frame() %>% slice(-c(27:30)) %>% select(3) %>% round(digits = 1)



tabc = calc_cro_cases(hh,
                  cell_vars = cell.vars, 
                  row_vars = row.vars, 
                  col_vars = total(),
                  weight = hh.weight, total_row_position = "none") %>% data.frame() %>% 
  select(2) %>% round(digits = 1) %>% slice(-c(27:30))


tab = taba %>% cbind(tabb, tabc)



unweighted <- calc_cro_cases(
    hh,
    cell_vars = nn,
    row_vars = row.vars,
    col_vars = total(),
    total_row_position = "none"
  ) %>% data.frame() %>% select(2) %>% 
  mutate(ind = ifelse(X.Total < 25, 1, 
               ifelse(X.Total %in% 25:49, 2,
                      3))) %>% slice(-c(27:30))





colnames(tab) = c(levels(as_factor(hh$Risk_S))[1:4], "Total", label(hh$EC_S), label(hh$nhhmem))

rownames(tab) = c("Total", levels(as_factor(hh$HH6)), levels(as_factor(hh$HH7)),
                   levels(as_factor(hh$helevel)), levels(as_factor(hh$watersource)),
                   levels(as_factor(hh$windex5)))





for (i in 1:nrow(tab)) 
  for (j in 1:ncol(tab)) 
  {
    tab[i, j] = ifelse(unweighted$ind[i] == 1, "(*)", 
                       ifelse(unweighted$ind[i] == 2, paste0("(", tab[i,j], ")"),
                              tab[i, j])) # else
  }




tab %>% 
  kable(digits = 1, format.args = list(big.mark = ",", scientific = FALSE)) %>% 
  kable_styling(c("striped"), font_size = 12) %>% 
  pack_rows(label(hh$HH6), 2, 3) %>% 
  pack_rows(label(hh$HH7), 4, 10) %>% 
  pack_rows(label(hh$helevel), 11, 15) %>%
  pack_rows(label(hh$watersource), 16, 25) %>% 
  pack_rows(label(hh$windex5), 26, 30) %>% 
  add_header_above(c(" " = 2, "Risk level based on the number of E. coli per 100 mL" = 4, " " = 2)) %>% 
  add_header_above(c("Table WS 1.6: Quality of source drinking water \n Percentage of household population at risk of faecal contamination based on
                     number of E. coli detected in source drinking water," = 8))
```

<table class="table table-striped" style="font-size: 12px; margin-left: auto; margin-right: auto;">

<thead>

<tr>

<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="8">

<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">

Table WS 1.6: Quality of source drinking water <br> Percentage of
household population at risk of faecal contamination based on<br> number
of E. coli detected in source drinking water,

</div>

</th>

</tr>

<tr>

<th style="border-bottom:hidden" colspan="2">

</th>

<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="4">

<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">

Risk level based on the number of E. coli per 100 mL

</div>

</th>

<th style="border-bottom:hidden" colspan="2">

</th>

</tr>

<tr>

<th style="text-align:left;">

</th>

<th style="text-align:left;">

Low (\<1 per 100 mL)

</th>

<th style="text-align:left;">

Moderate (1-10 per 100 mL)

</th>

<th style="text-align:left;">

High (11-100 per 100 mL)

</th>

<th style="text-align:left;">

Very high (\>100 per 100 mL)

</th>

<th style="text-align:left;">

Total

</th>

<th style="text-align:left;">

Percentage of household population with E. coli in source water \[1\]

</th>

<th style="text-align:left;">

Number of household members

</th>

</tr>

</thead>

<tbody>

<tr>

<td style="text-align:left;">

Total

</td>

<td style="text-align:left;">

79.5

</td>

<td style="text-align:left;">

10.2

</td>

<td style="text-align:left;">

5.5

</td>

<td style="text-align:left;">

4.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

20.5

</td>

<td style="text-align:left;">

10336.5

</td>

</tr>

<tr grouplength="2">

<td colspan="8" style="border-bottom: 1px solid;">

<strong>Area</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

URBAIN

</td>

<td style="text-align:left;">

84.1

</td>

<td style="text-align:left;">

7.6

</td>

<td style="text-align:left;">

4.4

</td>

<td style="text-align:left;">

3.9

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

15.9

</td>

<td style="text-align:left;">

7101.4

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

RURAL

</td>

<td style="text-align:left;">

69.5

</td>

<td style="text-align:left;">

15.9

</td>

<td style="text-align:left;">

7.8

</td>

<td style="text-align:left;">

6.7

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

30.5

</td>

<td style="text-align:left;">

3235.1

</td>

</tr>

<tr grouplength="7">

<td colspan="8" style="border-bottom: 1px solid;">

<strong>Region</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

DISTRICT TUNIS

</td>

<td style="text-align:left;">

81.1

</td>

<td style="text-align:left;">

7.4

</td>

<td style="text-align:left;">

5.9

</td>

<td style="text-align:left;">

5.7

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

18.9

</td>

<td style="text-align:left;">

2493

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

NORD EST

</td>

<td style="text-align:left;">

89.2

</td>

<td style="text-align:left;">

6.6

</td>

<td style="text-align:left;">

3.1

</td>

<td style="text-align:left;">

1.1

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

10.8

</td>

<td style="text-align:left;">

1485.2

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

NORD OUEST

</td>

<td style="text-align:left;">

78.2

</td>

<td style="text-align:left;">

12

</td>

<td style="text-align:left;">

4.6

</td>

<td style="text-align:left;">

5.2

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

21.8

</td>

<td style="text-align:left;">

1133.1

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

CENTRE EST

</td>

<td style="text-align:left;">

74.8

</td>

<td style="text-align:left;">

12

</td>

<td style="text-align:left;">

5.5

</td>

<td style="text-align:left;">

7.7

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

25.2

</td>

<td style="text-align:left;">

2423

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

CENTRE OUEST

</td>

<td style="text-align:left;">

78.4

</td>

<td style="text-align:left;">

10.2

</td>

<td style="text-align:left;">

7.6

</td>

<td style="text-align:left;">

3.9

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

21.6

</td>

<td style="text-align:left;">

1290.8

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

SUD EST

</td>

<td style="text-align:left;">

74.1

</td>

<td style="text-align:left;">

16.6

</td>

<td style="text-align:left;">

6

</td>

<td style="text-align:left;">

3.4

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

25.9

</td>

<td style="text-align:left;">

964.7

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

SUD OUEST

</td>

<td style="text-align:left;">

82.9

</td>

<td style="text-align:left;">

9.8

</td>

<td style="text-align:left;">

6

</td>

<td style="text-align:left;">

1.3

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

17.1

</td>

<td style="text-align:left;">

546.6

</td>

</tr>

<tr grouplength="5">

<td colspan="8" style="border-bottom: 1px solid;">

<strong>Education of household head</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Pre-primary or none

</td>

<td style="text-align:left;">

76.6

</td>

<td style="text-align:left;">

12.7

</td>

<td style="text-align:left;">

4.3

</td>

<td style="text-align:left;">

6.4

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

23.4

</td>

<td style="text-align:left;">

1907.6

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Primary

</td>

<td style="text-align:left;">

74.2

</td>

<td style="text-align:left;">

12.3

</td>

<td style="text-align:left;">

7.5

</td>

<td style="text-align:left;">

6

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

25.8

</td>

<td style="text-align:left;">

3865.3

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Secondary

</td>

<td style="text-align:left;">

83.8

</td>

<td style="text-align:left;">

7.6

</td>

<td style="text-align:left;">

5.1

</td>

<td style="text-align:left;">

3.6

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

16.2

</td>

<td style="text-align:left;">

3343.8

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Higher

</td>

<td style="text-align:left;">

89.3

</td>

<td style="text-align:left;">

7

</td>

<td style="text-align:left;">

2.1

</td>

<td style="text-align:left;">

1.6

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

10.7

</td>

<td style="text-align:left;">

1210.8

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Missing/DK

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

</tr>

<tr grouplength="10">

<td colspan="8" style="border-bottom: 1px solid;">

<strong>Main source of drinking water\[A\]</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Improved sources

</td>

<td style="text-align:left;">

80

</td>

<td style="text-align:left;">

10.1

</td>

<td style="text-align:left;">

5.3

</td>

<td style="text-align:left;">

4.6

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

20

</td>

<td style="text-align:left;">

10144.6

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Piped water

</td>

<td style="text-align:left;">

89.3

</td>

<td style="text-align:left;">

6.3

</td>

<td style="text-align:left;">

2.6

</td>

<td style="text-align:left;">

1.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

10.7

</td>

<td style="text-align:left;">

4604.6

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Tubewell/Borehole

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Protected well or spring

</td>

<td style="text-align:left;">

55.7

</td>

<td style="text-align:left;">

26.5

</td>

<td style="text-align:left;">

10.1

</td>

<td style="text-align:left;">

7.7

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

44.3

</td>

<td style="text-align:left;">

316.2

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Rainwater collection

</td>

<td style="text-align:left;">

45

</td>

<td style="text-align:left;">

26.8

</td>

<td style="text-align:left;">

13.6

</td>

<td style="text-align:left;">

14.6

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

55

</td>

<td style="text-align:left;">

1278.5

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Water kiosk

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

NA

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Tanker-truck/Cart will small tank

</td>

<td style="text-align:left;">

65.4

</td>

<td style="text-align:left;">

15.1

</td>

<td style="text-align:left;">

10.3

</td>

<td style="text-align:left;">

9.2

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

34.6

</td>

<td style="text-align:left;">

1363.8

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Bottled/Sachet water

</td>

<td style="text-align:left;">

93.5

</td>

<td style="text-align:left;">

3.4

</td>

<td style="text-align:left;">

2.2

</td>

<td style="text-align:left;">

0.9

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

6.5

</td>

<td style="text-align:left;">

2499.5

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Unimproved sources

</td>

<td style="text-align:left;">

55) 
    
    </td>
    
    <td style="text-align:left;">
    
    (16.4)
    
    </td>
    
    <td style="text-align:left;">
    
    (15.9)
    
    </td>
    
    <td style="text-align:left;">
    
    (12.6)
    
    </td>
    
    <td style="text-align:left;">
    
    100) 
         
         </td>
         
         <td style="text-align:left;">
         
         45) 
             
             </td>
             
             <td style="text-align:left;">
             
             (191.9)
             
             </td>
             
             </tr>
             
             <tr>
             
             <td style="text-align:left; padding-left: 2em;" indentlevel="1">
             
             Unprotected well or spring
             
             </td>
             
             <td style="text-align:left;">
             
             (51.2)
             
             </td>
             
             <td style="text-align:left;">
             
             (20.3)
             
             </td>
             
             <td style="text-align:left;">
             
             (8.9)
             
             </td>
             
             <td style="text-align:left;">
             
             (19.5)
             
             </td>
             
             <td style="text-align:left;">
             
             100) 
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  (48.8)
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  (109.7)
                  
                  </td>
                  
                  </tr>
                  
                  <tr grouplength="5">
                  
                  <td colspan="8" style="border-bottom: 1px solid;">
                  
                  <strong>Wealth index quintile</strong>
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Surface water/Other
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  79.8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  10.1
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  5.4
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  4.6
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  20.2
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  10226.8
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Poorest
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  61.1
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  19.3
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  9.3
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  10.3
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  38.9
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  1979.8
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Second
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  73.8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  14.7
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  5.9
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  5.7
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  26.2
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  2085.8
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Middle
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  82.6
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  4.8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  4.6
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  17.4
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  2082.6
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Fourth
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  87.2
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  4.8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  4.8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  3.2
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  12.8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  2153.6
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left;">
                  
                  Richest
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  92.2
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  4.7
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  2.7
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  0.4
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  7.8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  2034.6
                  
                  </td>
                  
                  </tr>
                  
                  </tbody>
                  
                  </table>

# WS 1.7

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav")) 

hh = hh %>% mutate(HHAGEx = ifelse(HHAGE %in% 15:19, 1,
                                   ifelse(HHAGE %in% 20:24, 2,
                                          ifelse(HHAGE %in% 25:49, 3,
                                                 ifelse(HHAGE >= 50, 4, HHAGE)))))

var_lab(hh$HHAGEx) = "Age of household head"

hh = hh %>% mutate(HHAGEy = ifelse(HHAGE %in% 15:19, 1,
                                   ifelse(HHAGE %in% 20:24, 2,
                                          ifelse(HHAGE %in% 25:29, 3,
                                                 ifelse(HHAGE %in% 30:34, 4,
                                                        ifelse(HHAGE %in% 35:39, 5, 
                                                               ifelse(HHAGE %in% 40:44, 6,
                                                                      ifelse(HHAGE %in% 45:49, 7,
                                                                             ifelse(HHAGE %in% 50:59, 8,
                                                                                    ifelse(HHAGE %in% 60:69, 9,
                                                                                           ifelse(HHAGE >= 70, 10, HHAGE)))))))))))


var_lab(hh$HHAGEy) = "Age of household head"


hh = hh %>% arrange(HH1, HH2) %>% 
  filter(WQ31 == 1) %>% 
  mutate(wqhweightHH48 = 0) %>% 
  mutate(wqhweightHH48 = ifelse(wqhweight > 0, wqhweight * HH48, wqhweightHH48)) %>% 
  mutate(nhhmem = wqhweightHH48)







hh <- hh %>% mutate(EC_100_H = NA) %>%
  mutate(EC_100_H = ifelse(WQ26 < 998 & WQ26 >= 100, 101,
                           ifelse(WQ26 < 101 | WQ26 >= 997, WQ26, EC_100_H)))




hh <- hh %>% mutate(Risk_H = ifelse(EC_100_H %in% 1:10, 1,
                                    ifelse(EC_100_H %in% 11:100, 2,
                                           ifelse(EC_100_H == 101, 3,
                                                  ifelse(EC_100_H >= 102, 9, EC_100_H)))))


var_lab(hh$EC_100_H) = "Risk level based on number of E. coli per 100 mL"
val_lab(hh$EC_100_H) = make_labels("
                                   0 Low (<1 per 100 mL) 
                                   1 Moderate (1-10 per 100 mL) 
                                   2 High (11-100 per 100 mL) 
                                   3 Very high (>100 per 100 mL) 
                                   9 DK/Missing
                                   ")



hh = hh %>% mutate(EC_H = 0) %>% 
  mutate(EC_H = ifelse(!Risk_H == 0, 100, EC_H))

var_lab(hh$EC_H) = "Percentage of household population with  E. coli in household drinking water [1]"


hh = hh %>% filter(Risk_H <= 3)






hh <- hh %>%
  mutate(impdrinkingWaterSource = ifelse(WS1 %in% 11:14, 11,
                                                    ifelse(WS1 == 21, 12,
                                                           ifelse(WS1 %in% c(31, 41), 13,
                                                                  ifelse(WS1 == 51, 14,
                                                                         ifelse(WS1 == 72, 15,
                                                                                ifelse(WS1 %in% c(61, 71), 16,
                                                                                       ifelse(WS1 %in% 91:92, 17, WS1)))))))) # else WS1?

hh = hh %>% mutate(unimpdrinkingWaterSource = ifelse(WS1 %in% c(32, 42), 21, 22))




hh <- hh %>% mutate(watersource = ifelse(impdrinkingWaterSource %in% 11:17, 10, 
                                         ifelse(unimpdrinkingWaterSource %in% 21:22, 20, NA)))



val_lab(hh$watersource) = make_labels("
  10 Improved sources
  11 Piped water
  12 Tubewell/Borehole
  13 Protected well or spring
  14 Rainwater collection
  15 Water kiosk                     
  16 Tanker-truck/Cart will small tank
  17 Bottled/Sachet water
  20 Unimproved sources
  21 Unprotected well or spring
  22 Surface water/Other
                                      ")


var_lab(hh$Risk_H) = "Risk level based on number of E. coli per 100 mL"
val_lab(hh$Risk_H) = make_labels("
                                 0 Low (<1 per 100 mL)
                                 1 Moderate (1-10 per 100 mL)
                                 2 High (11-100 per 100 mL)
                                 3 Very high (>100 per 100 mL)
                                 9 DK/Missing
                                 ")

var_lab(hh$nhhmem) = "Number of household members"
```

## SFR 1.7

``` r
# mrset(hh$watersource, hh$impdrinkingWaterSource, hh$unimpdrinkingWaterSource)

hh$nn = 1


row.vars = list(total(), hh$HH6, hh$HH7, hh$helevel, mrset(hh$watersource, hh$impdrinkingWaterSource, hh$unimpdrinkingWaterSource),
                hh$windex5)

col.vars = list(hh$sufficentwater, hh$WS8, hh$nmemnotsufficent, total())
```

    ## Warning: Unknown or uninitialised column: `sufficentwater`.

    ## Warning: Unknown or uninitialised column: `nmemnotsufficent`.

``` r
hh.weight = hh$nhhmem
cell.vars = hh$nn



taba = calc_cro_rpct(hh, cell_vars = cell.vars,
               row_vars = row.vars, 
               col_vars = list(hh$Risk_H, total()), 
               weight = hh.weight, total_row_position = "none") %>% data.frame() %>% select(c(2:5, 7)) %>% 
  slice(-c(27:30)) %>% round(digits = 1)



tabb = calc_cro_rpct(hh,
                   cell_vars = cell.vars, row_vars = row.vars, 
                   col_vars = hh$EC_H, weight = hh.weight, total_row_position = "none") %>% 
  data.frame() %>% slice(-c(27:30)) %>% select(3) %>% round(digits = 1)



tabc = calc_cro_cases(hh,
                  cell_vars = cell.vars, 
                  row_vars = row.vars, 
                  col_vars = total(),
                  weight = hh.weight, total_row_position = "none") %>% data.frame() %>% 
  select(2) %>% round(digits = 0) %>% slice(-c(27:30))


tab = taba %>% cbind(tabb, tabc)



unweighted <- calc_cro_cases(
    hh,
    cell_vars = nn,
    row_vars = row.vars,
    col_vars = total(),
    total_row_position = "none"
  ) %>% data.frame() %>% select(2) %>% 
  mutate(ind = ifelse(X.Total < 25, 1, 
               ifelse(X.Total %in% 25:49, 2,
                      3))) %>% slice(-c(27:30))





colnames(tab) = c(levels(as_factor(hh$Risk_H))[1:4], "Total", label(hh$EC_H), label(hh$nhhmem))

rownames(tab) = c("Total", levels(as_factor(hh$HH6)), levels(as_factor(hh$HH7)),
                   levels(as_factor(hh$helevel)), levels(as_factor(hh$watersource)),
                   levels(as_factor(hh$windex5)))





for (i in 1:nrow(tab)) 
  for (j in 1:ncol(tab)) 
  {
    tab[i, j] = ifelse(unweighted$ind[i] == 1, "(*)", 
                       ifelse(unweighted$ind[i] == 2, paste0("(", tab[i,j], ")"),
                              tab[i, j])) # else
  }




tab %>% 
  kable(digits = 1, format.args = list(big.mark = ",", scientific = FALSE)) %>% 
  kable_styling(c("striped"), font_size = 12) %>% 
  pack_rows(label(hh$HH6), 2, 3) %>% 
  pack_rows(label(hh$HH7), 4, 10) %>% 
  pack_rows(label(hh$helevel), 11, 15) %>%
  pack_rows(label(hh$watersource), 16, 25) %>% 
  pack_rows(label(hh$windex5), 26, 30) %>% 
  add_header_above(c(" " = 2, "Risk level based on the number of E. coli per 100 mL" = 4, " " = 2)) %>% 
  add_header_above(c("Table WS 1.7: Quality of source drinking water \n Percentage of household population at risk of faecal contamination based on
                     number of E. coli detected in source drinking water," = 8))
```

<table class="table table-striped" style="font-size: 12px; margin-left: auto; margin-right: auto;">

<thead>

<tr>

<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="8">

<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">

Table WS 1.7: Quality of source drinking water <br> Percentage of
household population at risk of faecal contamination based on<br> number
of E. coli detected in source drinking water,

</div>

</th>

</tr>

<tr>

<th style="border-bottom:hidden" colspan="2">

</th>

<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="4">

<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">

Risk level based on the number of E. coli per 100 mL

</div>

</th>

<th style="border-bottom:hidden" colspan="2">

</th>

</tr>

<tr>

<th style="text-align:left;">

</th>

<th style="text-align:left;">

Low (\<1 per 100 mL)

</th>

<th style="text-align:left;">

Moderate (1-10 per 100 mL)

</th>

<th style="text-align:left;">

High (11-100 per 100 mL)

</th>

<th style="text-align:left;">

Very high (\>100 per 100 mL)

</th>

<th style="text-align:left;">

Total

</th>

<th style="text-align:left;">

Percentage of household population with E. coli in household drinking
water \[1\]

</th>

<th style="text-align:left;">

Number of household members

</th>

</tr>

</thead>

<tbody>

<tr>

<td style="text-align:left;">

Total

</td>

<td style="text-align:left;">

71.1

</td>

<td style="text-align:left;">

15.8

</td>

<td style="text-align:left;">

7.3

</td>

<td style="text-align:left;">

5.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

28.9

</td>

<td style="text-align:left;">

10742

</td>

</tr>

<tr grouplength="2">

<td colspan="8" style="border-bottom: 1px solid;">

<strong>Area</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

URBAIN

</td>

<td style="text-align:left;">

76.9

</td>

<td style="text-align:left;">

13.2

</td>

<td style="text-align:left;">

5.2

</td>

<td style="text-align:left;">

4.7

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

23.1

</td>

<td style="text-align:left;">

7391

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

RURAL

</td>

<td style="text-align:left;">

58.4

</td>

<td style="text-align:left;">

21.6

</td>

<td style="text-align:left;">

12

</td>

<td style="text-align:left;">

8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

41.6

</td>

<td style="text-align:left;">

3350

</td>

</tr>

<tr grouplength="7">

<td colspan="8" style="border-bottom: 1px solid;">

<strong>Region</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

DISTRICT TUNIS

</td>

<td style="text-align:left;">

71

</td>

<td style="text-align:left;">

14.9

</td>

<td style="text-align:left;">

6.1

</td>

<td style="text-align:left;">

7.9

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

29

</td>

<td style="text-align:left;">

2584

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

NORD EST

</td>

<td style="text-align:left;">

81.2

</td>

<td style="text-align:left;">

11.2

</td>

<td style="text-align:left;">

6.7

</td>

<td style="text-align:left;">

0.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

18.8

</td>

<td style="text-align:left;">

1525

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

NORD OUEST

</td>

<td style="text-align:left;">

71.8

</td>

<td style="text-align:left;">

14.6

</td>

<td style="text-align:left;">

7.2

</td>

<td style="text-align:left;">

6.5

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

28.2

</td>

<td style="text-align:left;">

1176

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

CENTRE EST

</td>

<td style="text-align:left;">

68.1

</td>

<td style="text-align:left;">

16.3

</td>

<td style="text-align:left;">

6

</td>

<td style="text-align:left;">

9.6

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

31.9

</td>

<td style="text-align:left;">

2517

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

CENTRE OUEST

</td>

<td style="text-align:left;">

65.6

</td>

<td style="text-align:left;">

17.4

</td>

<td style="text-align:left;">

12.3

</td>

<td style="text-align:left;">

4.7

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

34.4

</td>

<td style="text-align:left;">

1355

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

SUD EST

</td>

<td style="text-align:left;">

67.7

</td>

<td style="text-align:left;">

24.6

</td>

<td style="text-align:left;">

6.1

</td>

<td style="text-align:left;">

1.7

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

32.3

</td>

<td style="text-align:left;">

999

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

SUD OUEST

</td>

<td style="text-align:left;">

75.4

</td>

<td style="text-align:left;">

13

</td>

<td style="text-align:left;">

10.9

</td>

<td style="text-align:left;">

0.7

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

24.6

</td>

<td style="text-align:left;">

586

</td>

</tr>

<tr grouplength="5">

<td colspan="8" style="border-bottom: 1px solid;">

<strong>Education of household head</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Pre-primary or none

</td>

<td style="text-align:left;">

67.6

</td>

<td style="text-align:left;">

16.9

</td>

<td style="text-align:left;">

7.3

</td>

<td style="text-align:left;">

8.1

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

32.4

</td>

<td style="text-align:left;">

1991

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Primary

</td>

<td style="text-align:left;">

66.6

</td>

<td style="text-align:left;">

17.4

</td>

<td style="text-align:left;">

9.4

</td>

<td style="text-align:left;">

6.6

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

33.4

</td>

<td style="text-align:left;">

3981

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Secondary

</td>

<td style="text-align:left;">

74.8

</td>

<td style="text-align:left;">

13.9

</td>

<td style="text-align:left;">

6.5

</td>

<td style="text-align:left;">

4.8

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

25.2

</td>

<td style="text-align:left;">

3490

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Higher

</td>

<td style="text-align:left;">

80.2

</td>

<td style="text-align:left;">

14.2

</td>

<td style="text-align:left;">

3.5

</td>

<td style="text-align:left;">

2.1

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

19.8

</td>

<td style="text-align:left;">

1271

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Missing/DK

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

</tr>

<tr grouplength="10">

<td colspan="8" style="border-bottom: 1px solid;">

<strong></strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Improved sources

</td>

<td style="text-align:left;">

71.7

</td>

<td style="text-align:left;">

15.7

</td>

<td style="text-align:left;">

7.1

</td>

<td style="text-align:left;">

5.6

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

28.3

</td>

<td style="text-align:left;">

10533

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Piped water

</td>

<td style="text-align:left;">

81

</td>

<td style="text-align:left;">

12.3

</td>

<td style="text-align:left;">

4.4

</td>

<td style="text-align:left;">

2.3

</td>

<td style="text-align:left;">

100

</td>

<td style="text-align:left;">

19

</td>

<td style="text-align:left;">

4683

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Tubewell/Borehole

</td>

<td style="text-align:left;">

29) 
    
    </td>
    
    <td style="text-align:left;">
    
    (12.2)
    
    </td>
    
    <td style="text-align:left;">
    
    (26.4)
    
    </td>
    
    <td style="text-align:left;">
    
    (32.3)
    
    </td>
    
    <td style="text-align:left;">
    
    100) 
         
         </td>
         
         <td style="text-align:left;">
         
         71) 
             
             </td>
             
             <td style="text-align:left;">
             
             109) 
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Protected well or spring
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  51.6
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  21.2
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  15.2
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  12
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  48.4
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  367
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Rainwater collection
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  39.6
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  29.6
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  15.4
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  15.4
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  60.4
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  1294
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Water kiosk
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  NA
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  NA
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  NA
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  NA
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  NA
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  NA
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  NA
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Tanker-truck/Cart will small tank
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  58.1
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  23.1
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  9.3
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  9.5
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  41.9
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  1480
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Bottled/Sachet water
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  83.3
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  9.9
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  4.4
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  2.3
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  16.7
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  2600
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Unimproved sources
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  42.2
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  22
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  20.8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  15
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  57.8
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  209
                  
                  </td>
                  
                  </tr>
                  
                  <tr>
                  
                  <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                  
                  Unprotected well or spring
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  (36.1)
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  (27.8)
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  (20.8)
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  (15.3)
                  
                  </td>
                  
                  <td style="text-align:left;">
                  
                  100) 
                       
                       </td>
                       
                       <td style="text-align:left;">
                       
                       (63.9)
                       
                       </td>
                       
                       <td style="text-align:left;">
                       
                       122) 
                            
                            </td>
                            
                            </tr>
                            
                            <tr grouplength="5">
                            
                            <td colspan="8" style="border-bottom: 1px solid;">
                            
                            <strong>Wealth index quintile</strong>
                            
                            </td>
                            
                            </tr>
                            
                            <tr>
                            
                            <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                            
                            Surface water/Other
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            71.5
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            15.6
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            7.2
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            5.7
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            100
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            28.5
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            10619
                            
                            </td>
                            
                            </tr>
                            
                            <tr>
                            
                            <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                            
                            Poorest
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            52.6
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            22.8
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            12.5
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            12.1
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            100
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            47.4
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            2103
                            
                            </td>
                            
                            </tr>
                            
                            <tr>
                            
                            <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                            
                            Second
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            64
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            20.2
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            10.2
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            5.6
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            100
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            36
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            2163
                            
                            </td>
                            
                            </tr>
                            
                            <tr>
                            
                            <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                            
                            Middle
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            75
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            14.6
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            4.7
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            5.7
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            100
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            25
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            2138
                            
                            </td>
                            
                            </tr>
                            
                            <tr>
                            
                            <td style="text-align:left; padding-left: 2em;" indentlevel="1">
                            
                            Fourth
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            79.9
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            10.7
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            5.2
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            4.2
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            100
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            20.1
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            2236
                            
                            </td>
                            
                            </tr>
                            
                            <tr>
                            
                            <td style="text-align:left;">
                            
                            Richest
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            83.5
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            10.8
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            4.2
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            1.4
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            100
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            16.5
                            
                            </td>
                            
                            <td style="text-align:left;">
                            
                            2102
                            
                            </td>
                            
                            </tr>
                            
                            </tbody>
                            
                            </table>

# WS 1.8

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav")) %>% arrange(HH1, HH2) %>% 
  filter(WQ31 == 1) %>% 
  mutate(wqsweightHH48 = 0) %>% 
  mutate(wqsweightHH48 = ifelse(wqsweight > 0, wqsweight * HH48, wqsweightHH48)) %>% 
  mutate(nhhmem = wqsweightHH48)

var_lab(hh$nhhmem) = "Number of household members"

source(here("R/drinkingWater.R"))


hh <- hh %>% mutate(EC_100_S = NA) %>% 
  mutate(EC_100_S = ifelse(WQ27 < 997 & WQ27 >= 100, 101,
                           ifelse(WQ27 < 101 | WQ27 >= 997, WQ27, EC_100_S)))


hh <- hh %>% mutate(Risk_S = ifelse(EC_100_S %in% 1:10, 1,
                                      ifelse(EC_100_S %in% 11:100, 2,
                                             ifelse(EC_100_S == 101, 3,
                                                    ifelse(EC_100_S >= 102, 9, EC_100_S)))))


var_lab(hh$Risk_S) = "Risk level based on number of E. coli per 100 mL"
val_lab(hh$Risk_S) = make_labels("
                                 0 Low (<1 per 100 mL)
                                 1 Moderate (1-10 per 100 mL)
                                 2 High (11-100 per 100 mL)
                                 3 Very high (>100 per 100 mL)
                                 9 DK/Missing
                                 ")




hh = hh %>% mutate(WithoutEC_S = 0) %>% 
  mutate(WithoutEC_S = ifelse(Risk_S == 0, 100, WithoutEC_S))


var_lab(hh$WithoutEC_S) = "Without E. coli in drinking water source"


hh <- hh %>% mutate(sufficentwater = 0) %>% 
  mutate(sufficentwater = ifelse(WS7 == 2, 100, sufficentwater))

var_lab(hh$sufficentwater) = "Percentage of household population with drinking water available in sufficient quantities [1]"



hh = hh %>% mutate(wpremises = 0) %>% 
  mutate(wpremises = ifelse(WS1 %in% 11:13 | WS2 %in% 11:13 | WS3 %in% 1:2, 100, wpremises))

var_lab(hh$wpremises) = "Drinking water accessible on premises"



hh = hh %>% mutate(indSDG611 = 0) %>% 
  mutate(indSDG611 = ifelse(drinkingWater == 1 & WithoutEC_S == 100 & sufficentwater == 100 & wpremises == 100, 100, indSDG611))



hh = hh %>% filter(Risk_S <= 3)



hh <- hh %>%
  mutate(impdrinkingWaterSource = ifelse(WS1 %in% 11:14, 11,
                                                    ifelse(WS1 == 21, 12,
                                                           ifelse(WS1 %in% c(31, 41), 13,
                                                                  ifelse(WS1 == 51, 14,
                                                                         ifelse(WS1 == 72, 15,
                                                                                ifelse(WS1 %in% c(61, 71), 16,
                                                                                       ifelse(WS1 %in% 91:92, 17, WS1)))))))) # else WS1?

hh = hh %>% mutate(unimpdrinkingWaterSource = ifelse(WS1 %in% c(32, 42), 21, 22))




hh <- hh %>% mutate(watersource = ifelse(impdrinkingWaterSource %in% 11:17, 10, 
                                         ifelse(unimpdrinkingWaterSource %in% 21:22, 20, NA)))


val_lab(hh$watersource) = make_labels("
  10 Improved sources
  11 Piped water
  12 Tubewell/Borehole
  13 Protected well or spring
  14 Rainwater collection
  15 Water kiosk                     
  16 Tanker-truck/Cart will small tank
  17 Bottled/Sachet water
  20 Unimproved sources
  21 Unprotected well or spring
  22 Surface water/Other
                                      ")
```

## SFR 1.8

``` r
# mrset(hh$watersource, hh$impdrinkingWaterSource, hh$unimpdrinkingWaterSource)

hh$nn = 1


row.vars = list(total(), hh$HH6, hh$HH7, hh$helevel, mrset(hh$watersource, hh$impdrinkingWaterSource, hh$unimpdrinkingWaterSource),
                hh$windex5)

col.vars = list(hh$sufficentwater, hh$WS8, hh$nmemnotsufficent, total())
hh.weight = hh$nhhmem
cell.vars = hh$nn



taba = calc_cro_rpct(hh, cell_vars = total(),
               row_vars = row.vars, 
               col_vars = list(hh$WithoutEC_S, hh$sufficentwater, hh$wpremises, hh$indSDG611), 
               weight = hh.weight, total_row_position = "none") %>% data.frame() %>% slice(-c(27:30)) %>% 
  select(c(3, 5, 7, 9, 10:12)) %>% 
    round(digits = 1)



tabb = calc_cro_rpct(hh,
                   cell_vars = cell.vars, row_vars = row.vars, 
                   col_vars = hh$EC_H, weight = hh.weight, total_row_position = "none") %>% 
  data.frame() %>% slice(-c(27:30)) %>% select(3) %>% round(digits = 1)



tabc = calc_cro_cases(hh,
                  cell_vars = cell.vars, 
                  row_vars = row.vars, 
                  col_vars = total(),
                  weight = hh.weight, total_row_position = "none") %>% data.frame() %>% 
  select(2) %>% round(digits = 0) %>% slice(-c(27:30))


tab = taba %>% cbind(tabb, tabc)



unweighted <- calc_cro_cases(
    hh,
    cell_vars = nn,
    row_vars = row.vars,
    col_vars = total(),
    total_row_position = "none"
  ) %>% data.frame() %>% select(2) %>% 
  mutate(ind = ifelse(X.Total < 25, 1, 
               ifelse(X.Total %in% 25:49, 2,
                      3))) %>% slice(-c(27:30))





colnames(tab) = c(levels(as_factor(hh$Risk_H))[1:4], "Total", label(hh$EC_H), label(hh$nhhmem))

rownames(tab) = c("Total", levels(as_factor(hh$HH6)), levels(as_factor(hh$HH7)),
                   levels(as_factor(hh$helevel)), levels(as_factor(hh$watersource)),
                   levels(as_factor(hh$windex5)))





for (i in 1:nrow(tab)) 
  for (j in 1:ncol(tab)) 
  {
    tab[i, j] = ifelse(unweighted$ind[i] == 1, "(*)", 
                       ifelse(unweighted$ind[i] == 2, paste0("(", tab[i,j], ")"),
                              tab[i, j])) # else
  }




tab %>% 
  kable(digits = 1, format.args = list(big.mark = ",", scientific = FALSE)) %>% 
  kable_styling(c("striped"), font_size = 12) %>% 
  pack_rows(label(hh$HH6), 2, 3) %>% 
  pack_rows(label(hh$HH7), 4, 10) %>% 
  pack_rows(label(hh$helevel), 11, 15) %>%
  pack_rows(label(hh$watersource), 16, 25) %>% 
  pack_rows(label(hh$windex5), 26, 30) %>% 
  add_header_above(c(" " = 2, "Risk level based on the number of E. coli per 100 mL" = 4, " " = 2)) %>% 
  add_header_above(c("Table WS 1.7: Quality of source drinking water \n Percentage of household population at risk of faecal contamination based on
                     number of E. coli detected in source drinking water," = 8))
```

# WS 1.9

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav"))

hh <- hh %>% filter(HH46 == 1) %>% 
  mutate(hhweightHH48 = HH48 * hhweight) %>% mutate(nhhmem = 1 * hhweightHH48)

var_lab(hh$nhhmem) = "Number of household members"; 
val_lab(hh$nhhmem) = make_labels("
1                        ")



hh <- hh %>% mutate(treat = 1)
val_lab(hh$treat) = make_labels("
                                1 Water treatment method used in the household
                                ")


hh <- hh %>% mutate(none = 0) %>% 
  mutate(none = ifelse(!WS9 == 1, 100, none))




hh <- hh %>% mutate(boil = ifelse(WS10A == "A", 100, 0)); var_lab(hh$boil) = "Boil"

hh <- hh %>% mutate(bleach = ifelse(WS10B == "B", 100, 0),
                    cloth = ifelse(WS10C == "C", 100, 0),
                    waterFilter = ifelse(WS10D == "D", 100, 0),
                    solar = ifelse(WS10E == "E", 100, 0),
                    stand = ifelse(WS10F == "F", 100, 0),
                    other = ifelse(WS10X == "X", 100, 0),
                    dkmissing = ifelse(WS10Z == "Z" | WS10NR == "?", 100, 0))



source(here("R/drinkingWater.R"))



hh <- hh %>% mutate(appropriate = 0) %>% 
  mutate(appropriate = ifelse(boil == 100 | bleach == 100 | waterFilter == 100 | solar == 100, 100, appropriate))


var_lab(hh$appropriate) = "Percentage of household members in households using an appropriate water treatment method"




var.labs = list(boil = "Boil", bleach = "Add bleach / chlorine", cloth = "Strain through a cloth",
                waterFilter = "Use water filter", solar = "Solar disinfection", stand = "Let it stand and settle", other = "Other", dkmissing = "Dk/Missing")


var_lab(hh$boil) = "Boil"; var_lab(hh$bleach) = "Add bleach / chlorine"; var_lab(hh$cloth) = "Strain through a cloth"
var_lab(hh$waterFilter) = "Use water filter"; var_lab(hh$solar) = "Solar disinfection"; var_lab(hh$stand) = "Let it stand and settle"
var_lab(hh$other) = "Other"; var_lab(hh$dkmissing) = "DK/Missing"; var_lab(hh$none) = "None"
```

## SFR 1.9

``` r
# mrset(hh$watersource, hh$impdrinkingWaterSource, hh$unimpdrinkingWaterSource)

hh$nn = 1


row.vars = list(total(), hh$HH6, hh$HH7, hh$helevel, hh$drinkingWater, hh$windex5)

col.vars = list(hh$sufficentwater, hh$WS8, hh$nmemnotsufficent, total())
```

    ## Warning: Unknown or uninitialised column: `sufficentwater`.

    ## Warning: Unknown or uninitialised column: `nmemnotsufficent`.

``` r
hh.weight = hh$nhhmem
cell.vars = hh$nn



taba = calc_cro_rpct(hh, hh$nn,
               row_vars = row.vars, 
               col_vars = list(hh$none, hh$boil, hh$bleach, hh$cloth, hh$waterFilter, hh$solar, hh$stand, hh$other, hh$dkmissing, hh$appropriate), 
               weight = hh.weight, total_row_position = "none") %>% data.frame() %>% 
  select(c(3, 5, 7, 9, 11, 13, 15, 17, 18, 20)) %>% round(digits = 1)


tabb = calc_cro_cases(hh, cell_vars = hh$nn,
                      row_vars = row.vars,
                      col_vars = total(),
                      weight = hh.weight, 
                      total_row_position = "none") %>% data.frame() %>% select(2) %>% round(digits = 0)




tab = taba %>% cbind(tabb)
tab[,9] = tab[,9] - 100


unweighted <- calc_cro_cases(
    hh,
    cell_vars = nn,
    row_vars = row.vars,
    col_vars = total(),
    total_row_position = "none"
  ) %>% data.frame() %>% select(2) %>% 
  mutate(ind = ifelse(X.Total < 25, 1, 
               ifelse(X.Total %in% 25:49, 2,
                      3))) 





colnames(tab) = c(label(hh$none), label(hh$boil), label(hh$bleach), label(hh$cloth), label(hh$waterFilter), label(hh$solar),
                  label(hh$stand), label(hh$other), label(hh$dkmissing), label(hh$appropriate), label(hh$nhhmem))

rownames(tab) = c("Total", levels(as_factor(hh$HH6)), levels(as_factor(hh$HH7)),
                   levels(as_factor(hh$helevel)), levels(as_factor(hh$drinkingWater)),
                   levels(as_factor(hh$windex5)))





for (i in 1:nrow(tab)) 
  for (j in 1:ncol(tab)) 
  {
    tab[i, j] = ifelse(unweighted$ind[i] == 1, "(*)", 
                       ifelse(unweighted$ind[i] == 2, paste0("(", tab[i,j], ")"),
                              tab[i, j])) # else
  }




tab %>% 
  kable(digits = 1, format.args = list(big.mark = ",", scientific = FALSE)) %>% 
  kable_styling(c("striped"), font_size = 12) %>% 
  pack_rows(label(hh$HH6), 2, 3) %>% 
  pack_rows(label(hh$HH7), 4, 10) %>% 
  pack_rows(label(hh$helevel), 11, 15) %>%
  pack_rows(label(hh$drinkingWater), 16, 17) %>% 
  pack_rows(label(hh$windex5), 18, 22) %>% 
  add_header_above(c(" " = 2, "Water treatment method used in the household" = 9, " " = 1)) %>% 
  add_header_above(c("Table WS 1.9: Household water treatment \n Percentage of household population by drinking water treatment method used in the
                     household and the percentage who are using an appropriate treatment method" = 12))
```

<table class="table table-striped" style="font-size: 12px; margin-left: auto; margin-right: auto;">

<thead>

<tr>

<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="12">

<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">

Table WS 1.9: Household water treatment <br> Percentage of household
population by drinking water treatment method used in the<br> household
and the percentage who are using an appropriate treatment method

</div>

</th>

</tr>

<tr>

<th style="border-bottom:hidden" colspan="2">

</th>

<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="9">

<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">

Water treatment method used in the household

</div>

</th>

<th style="border-bottom:hidden" colspan="1">

</th>

</tr>

<tr>

<th style="text-align:left;">

</th>

<th style="text-align:left;">

None

</th>

<th style="text-align:left;">

Boil

</th>

<th style="text-align:left;">

Add bleach / chlorine

</th>

<th style="text-align:left;">

Strain through a cloth

</th>

<th style="text-align:left;">

Use water filter

</th>

<th style="text-align:left;">

Solar disinfection

</th>

<th style="text-align:left;">

Let it stand and settle

</th>

<th style="text-align:left;">

Other

</th>

<th style="text-align:left;">

DK/Missing

</th>

<th style="text-align:left;">

Percentage of household members in households using an appropriate water
treatment method

</th>

<th style="text-align:left;">

Number of household members

</th>

</tr>

</thead>

<tbody>

<tr>

<td style="text-align:left;">

Total

</td>

<td style="text-align:left;">

89.3

</td>

<td style="text-align:left;">

0.7

</td>

<td style="text-align:left;">

7.3

</td>

<td style="text-align:left;">

3.3

</td>

<td style="text-align:left;">

1

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

8.8

</td>

<td style="text-align:left;">

43638

</td>

</tr>

<tr grouplength="2">

<td colspan="12" style="border-bottom: 1px solid;">

<strong>Area</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

URBAIN

</td>

<td style="text-align:left;">

92.2

</td>

<td style="text-align:left;">

0.8

</td>

<td style="text-align:left;">

5.2

</td>

<td style="text-align:left;">

1.9

</td>

<td style="text-align:left;">

1.1

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

6.9

</td>

<td style="text-align:left;">

29853

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

RURAL

</td>

<td style="text-align:left;">

83

</td>

<td style="text-align:left;">

0.5

</td>

<td style="text-align:left;">

11.8

</td>

<td style="text-align:left;">

6.2

</td>

<td style="text-align:left;">

0.7

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.6

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

12.8

</td>

<td style="text-align:left;">

13785

</td>

</tr>

<tr grouplength="7">

<td colspan="12" style="border-bottom: 1px solid;">

<strong>Region</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

DISTRICT TUNIS

</td>

<td style="text-align:left;">

97.3

</td>

<td style="text-align:left;">

1

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

1.4

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

2.5

</td>

<td style="text-align:left;">

10398

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

NORD EST

</td>

<td style="text-align:left;">

95.8

</td>

<td style="text-align:left;">

0.8

</td>

<td style="text-align:left;">

2

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0.4

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

1

</td>

<td style="text-align:left;">

0.4

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

3.1

</td>

<td style="text-align:left;">

6146

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

NORD OUEST

</td>

<td style="text-align:left;">

90

</td>

<td style="text-align:left;">

1.3

</td>

<td style="text-align:left;">

2.7

</td>

<td style="text-align:left;">

6.6

</td>

<td style="text-align:left;">

0.4

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.4

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

3.9

</td>

<td style="text-align:left;">

4777

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

CENTRE EST

</td>

<td style="text-align:left;">

82.3

</td>

<td style="text-align:left;">

0.7

</td>

<td style="text-align:left;">

13.6

</td>

<td style="text-align:left;">

4.4

</td>

<td style="text-align:left;">

1.3

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0.4

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

15.4

</td>

<td style="text-align:left;">

10289

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

CENTRE OUEST

</td>

<td style="text-align:left;">

91.8

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

6.3

</td>

<td style="text-align:left;">

2.1

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

6.6

</td>

<td style="text-align:left;">

5584

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

SUD EST

</td>

<td style="text-align:left;">

68.2

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

28.2

</td>

<td style="text-align:left;">

12.8

</td>

<td style="text-align:left;">

0.9

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.6

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

29

</td>

<td style="text-align:left;">

3957

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

SUD OUEST

</td>

<td style="text-align:left;">

95.4

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

1.7

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

2.3

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

4.2

</td>

<td style="text-align:left;">

2486

</td>

</tr>

<tr grouplength="5">

<td colspan="12" style="border-bottom: 1px solid;">

<strong>Education of household head</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Pre-primary or none

</td>

<td style="text-align:left;">

90.5

</td>

<td style="text-align:left;">

0.6

</td>

<td style="text-align:left;">

6.7

</td>

<td style="text-align:left;">

3.3

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

7.3

</td>

<td style="text-align:left;">

7899

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Primary

</td>

<td style="text-align:left;">

88.1

</td>

<td style="text-align:left;">

0.7

</td>

<td style="text-align:left;">

7.9

</td>

<td style="text-align:left;">

3.9

</td>

<td style="text-align:left;">

1

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

9.4

</td>

<td style="text-align:left;">

16191

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Secondary

</td>

<td style="text-align:left;">

89.6

</td>

<td style="text-align:left;">

0.8

</td>

<td style="text-align:left;">

7.1

</td>

<td style="text-align:left;">

3.2

</td>

<td style="text-align:left;">

1.3

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

9

</td>

<td style="text-align:left;">

14179

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Higher

</td>

<td style="text-align:left;">

90.4

</td>

<td style="text-align:left;">

0.7

</td>

<td style="text-align:left;">

7

</td>

<td style="text-align:left;">

1.5

</td>

<td style="text-align:left;">

1.3

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0.4

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

8.8

</td>

<td style="text-align:left;">

5294

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Missing/DK

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

<td style="text-align:left;">

(\*)

</td>

</tr>

<tr grouplength="2">

<td colspan="12" style="border-bottom: 1px solid;">

<strong>Source of drinking water</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Improved

</td>

<td style="text-align:left;">

89.4

</td>

<td style="text-align:left;">

0.7

</td>

<td style="text-align:left;">

7.3

</td>

<td style="text-align:left;">

3.1

</td>

<td style="text-align:left;">

1

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

8.8

</td>

<td style="text-align:left;">

42768

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Unimproved

</td>

<td style="text-align:left;">

82.5

</td>

<td style="text-align:left;">

2.1

</td>

<td style="text-align:left;">

6.4

</td>

<td style="text-align:left;">

10.5

</td>

<td style="text-align:left;">

0.6

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.5

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

8

</td>

<td style="text-align:left;">

870

</td>

</tr>

<tr grouplength="5">

<td colspan="12" style="border-bottom: 1px solid;">

<strong>Wealth index quintile</strong>

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Poorest

</td>

<td style="text-align:left;">

79.9

</td>

<td style="text-align:left;">

0.8

</td>

<td style="text-align:left;">

13.8

</td>

<td style="text-align:left;">

8.3

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.6

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

14.6

</td>

<td style="text-align:left;">

8728

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Second

</td>

<td style="text-align:left;">

84.1

</td>

<td style="text-align:left;">

0.6

</td>

<td style="text-align:left;">

13.1

</td>

<td style="text-align:left;">

5.2

</td>

<td style="text-align:left;">

0.5

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0.4

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

14

</td>

<td style="text-align:left;">

8727

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Middle

</td>

<td style="text-align:left;">

90.8

</td>

<td style="text-align:left;">

0.8

</td>

<td style="text-align:left;">

6.7

</td>

<td style="text-align:left;">

2.2

</td>

<td style="text-align:left;">

0.7

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

8.1

</td>

<td style="text-align:left;">

8726

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Fourth

</td>

<td style="text-align:left;">

95.1

</td>

<td style="text-align:left;">

0.8

</td>

<td style="text-align:left;">

2.3

</td>

<td style="text-align:left;">

0.4

</td>

<td style="text-align:left;">

1.5

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

0.3

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

4.4

</td>

<td style="text-align:left;">

8731

</td>

</tr>

<tr>

<td style="text-align:left; padding-left: 2em;" indentlevel="1">

Richest

</td>

<td style="text-align:left;">

96.6

</td>

<td style="text-align:left;">

0.6

</td>

<td style="text-align:left;">

0.7

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

1.9

</td>

<td style="text-align:left;">

NA

</td>

<td style="text-align:left;">

0.1

</td>

<td style="text-align:left;">

0.2

</td>

<td style="text-align:left;">

0

</td>

<td style="text-align:left;">

3

</td>

<td style="text-align:left;">

8725

</td>

</tr>

</tbody>

</table>

# WS 2.1

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav"))
hh <- hh %>% filter(HH46 == 1) %>% 
  mutate(hhweightHH48 = HH48 * hhweight) %>% mutate(nhhmem = 1 * hhweightHH48)

var_lab(hh$nhhmem) = "Number of household members"; 
val_lab(hh$nhhmem) = make_labels("
1                        ")


hh <- hh %>% mutate(layer1 = 0,
                    layer2 = 0,
                    fixedobserved = ifelse(HW1 == 1 | HW1 == 2, 100, 0),
                    mobileobserved = ifelse(HW1 == 3, 100, 0),
                    noplace = ifelse(HW1 == 4, 100, 0),
                    nopermission = ifelse(HW1 >= 5, 100, 0))


val_lab(hh$layer1) = make_labels("
                                 0 Handwashing facility observed
                                 ")

val_lab(hh$layer2) = make_labels("
                                 0 Handwashing facility observed and
                                 ")



hh <- hh %>% mutate(numHouseholdsObs = ifelse(fixedobserved == 100 | mobileobserved == 100, 1, 0)) %>% 
  mutate(water = ifelse(HW2 == 1, 100, 0),
         Soap = ifelse(HW7A == "A" | HW7B == "B", 100, 0),
         Ash = ifelse(HW7C == "C", 100, 0),
         numHHObsnoplace = ifelse(fixedobserved == 100 | noplace == 100, 1, 0)) %>% 
  mutate(indWS7 = ifelse(HW2 == 1 & (HW7A == "A" | HW7B == "B"), 100, 0))



var_lab(hh$water) = "water available"; var_lab(hh$Soap) = "soap available"
var_lab(hh$Ash) = "with ash/mud/sand available"

var_lab(hh$indWS7) = "Percentage of household members with handwashing facility where water and soap are present[1]"

val_lab(hh$numHouseholdsObs) = make_labels("
                                           1 Number of household members where handwashing facility was observed
                                           ")
```

# WS 3.1

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav"))
hh <- hh %>% filter(HH46 == 1) %>% 
  mutate(hhweightHH48 = HH48 * hhweight) %>% mutate(nhhmem = 1 * hhweightHH48)

var_lab(hh$nhhmem) = "Number of household members"; 
val_lab(hh$nhhmem) = make_labels("
1                        ")



source(here("R/drinkingWater.R"))


hh <- hh %>% mutate(WS11 = ifelse(WS11 %in% 97:99, 99, WS11))
val_lab(hh$WS11) = make_labels("
  95  
    99 DK/Missing
                               ")




hh <- hh %>% mutate(improvepercent = ifelse(toiletType == 1, 100, 0)); var_lab(hh$improvepercent) = "Percentage using improved sanitation [1]"

hh = hh %>% mutate(WS14 = ifelse(WS11 == 95, 4, WS14)); var_lab(hh$WS14) = "Location of sanitation facility"
val_lab(hh$WS14) = make_labels("
                               4 Open defecation (no facility, bush, field)
                               ")



var_lab(hh$toiletType) = "Type of sanitation facility used by household"
val_lab(hh$toiletType) = make_labels("
                                     1 Improved sanitation facility
                                     2 Unimproved sanitation facility
                                     3 Open defecation (no facility, bush, field)
                                     ")
```

\#WS 3.2

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav"))

hh <- hh %>% filter(HH46 == 1) %>% 
  mutate(hhweightHH48 = HH48 * hhweight) %>% mutate(nhhmem = 1 * hhweightHH48)

var_lab(hh$nhhmem) = "Number of household members"; 
val_lab(hh$nhhmem) = make_labels("
1                        ")



source(here("R/drinkingWater.R"))



hh = hh %>% mutate(shared1 = ifelse(toiletType == 1, sharedToilet, NA))

var_lab(hh$shared1) = "Users of improved sanitation facilities"
val_lab(hh$shared1) = make_labels("
  0 Not shared [1]
  1 Shared by: 5 households or less
  2 Shared by: More than 5 households
  3 Public facility
  9 DK/Missing
                                  ")


hh = hh %>% mutate(shared2 = ifelse(toiletType == 2, sharedToilet, NA))
var_lab(hh$shared2) = "Users of unimproved sanitation facilities"
val_lab(hh$shared2) = make_labels("
  0 Not shared
  1 Shared by: 5 households or less
  2 Shared by: More than 5 households
  3 Public facility
  9 DK/Missing
                                  ")




hh = hh %>% mutate(shared3 = ifelse(toiletType == 3, 1, NA))

hh = hh %>% mutate(WS14 = ifelse(WS11 == 95, 4, WS14))
var_lab(hh$WS14) = "Location of sanitation facility"
```

\#WS 3.3

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav")) %>% 
  mutate(onsite = ifelse(WS11 == 12, 1,
                         ifelse(WS11 %in% c(13, 21, 22, 31), 2, 0)))

var_lab(hh$onsite) = "Type of onsite sanitation facility"

hh = hh %>% filter(HH46 == 1, !onsite == 0) %>% 
  mutate(hhweightHH48 = HH48 * hhweight) %>% mutate(nhhmem = 1 * hhweightHH48)

var_lab(hh$nhhmem) = "Number of household members"; 
val_lab(hh$nhhmem) = make_labels("
1                        ")


source(here("R/drinkingWater.R"))

# septic tank

hh <- hh %>% mutate(septicemptiedproviderplant = ifelse(onsite == 1 & WS13 == 1, 100, 0),
                    septicemptiedproviderDK = ifelse(onsite == 1 & WS13 == 3, 100, 0),
                    septicemptiedpit = ifelse(onsite == 1 & (WS13 == 2 | WS13 == 4), 100, 0),
                    septicemptiedHHpit = ifelse(onsite == 1 & WS13 == 5, 100, 0),
                    septicemptiedother = ifelse(onsite == 1 & WS13 == 6, 100, 0),
                    septicemptiedDK = ifelse(onsite == 1 & WS13 == 8, 100, 0),
                    septicneveremptied = ifelse(onsite == 1 & WS12 == 4, 100, 0),
                    septicDKemptied = ifelse(onsite == 1 & WS12 >= 8, 100, 0))

# other improved on-site sanitation facilities
hh <- hh %>% mutate(Oonsiteemptiedproviderplant = ifelse(onsite == 2 & WS13 == 1, 100, 0),
                    OonsiteemptiedproviderDK = ifelse(onsite == 2 & WS13 == 3, 100, 0),
                    Oonsiteemptiedpit = ifelse(onsite == 2 & (WS13 == 2 | WS13 == 4), 100, 0),
                    OonsiteemptiedHHpit = ifelse(onsite == 2 & WS13 == 5, 100, 0),
                    Oonsiteemptiedother = ifelse(onsite == 2 & WS13 == 6, 100, 0),
                    OonsiteemptiedDK = ifelse(onsite == 1 & WS13 == 8, 100, 0),
                    Oonsiteneveremptied = ifelse(onsite == 2 & WS12 == 4, 100, 0),
                    OonsiteDKemptied = ifelse(onsite == 2 & WS12 >= 8, 100, 0))


hh = hh %>% mutate(safedisposal = ifelse(septicemptiedpit == 100 | septicneveremptied == 100 | septicDKemptied == 100 | Oonsiteemptiedpit == 100 |
                                           Oonsiteneveremptied == 100 | OonsiteDKemptied == 100, 100, 0),
                   unsafedisposal = ifelse(septicemptiedHHpit == 100 | septicemptiedother == 100 | OonsiteemptiedHHpit == 100 |
                                             Oonsiteemptiedother == 100, 100, 0),
                   treatment = ifelse(septicemptiedproviderplant == 100 | septicemptiedproviderDK == 100 | septicemptiedDK == 100 | 
                                        Oonsiteemptiedproviderplant == 100 | OonsiteemptiedproviderDK == 100 | OonsiteemptiedDK == 100, 100, 0))


hh = hh %>% mutate(layer1 = 0, layer2 = 0)
hh = hh %>% mutate(WS11c = ifelse(is.na(WS11), 12, WS11))
```

\#WS 3.4

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav"))


source(here("R/commonVarsHH.R"))

hh = hh %>% filter(HH46 == 1) %>% 
  mutate(onsite = ifelse(WS11 == 12, 1,
                         ifelse(WS11 %in% c(13, 21, 22, 31), 2, 0)))


source(here("R/drinkingWater.R"))



hh = hh %>% filter(HH46 == 1) %>% 
  mutate(hhweightHH48 = HH48 * hhweight) %>% mutate(nhhmem = 1 * hhweightHH48)

var_lab(hh$nhhmem) = "Number of household members"; 
val_lab(hh$nhhmem) = make_labels("
1                        ")



# septic tank

hh <- hh %>% mutate(septicemptiedproviderplant = ifelse(onsite == 1 & WS13 == 1, 100, 0),
                    septicemptiedproviderDK = ifelse(onsite == 1 & WS13 == 3, 100, 0),
                    septicemptiedpit = ifelse(onsite == 1 & (WS13 == 2 | WS13 == 4), 100, 0),
                    septicemptiedHHpit = ifelse(onsite == 1 & WS13 == 5, 100, 0),
                    septicemptiedother = ifelse(onsite == 1 & WS13 == 6, 100, 0),
                    septicemptiedDK = ifelse(onsite == 1 & WS13 == 8, 100, 0),
                    septicneveremptied = ifelse(onsite == 1 & WS12 == 4, 100, 0),
                    septicDKemptied = ifelse(onsite == 1 & WS12 >= 8, 100, 0))

# other improved on-site sanitation facilities
hh <- hh %>% mutate(Oonsiteemptiedproviderplant = ifelse(onsite == 2 & WS13 == 1, 100, 0),
                    OonsiteemptiedproviderDK = ifelse(onsite == 2 & WS13 == 3, 100, 0),
                    Oonsiteemptiedpit = ifelse(onsite == 2 & (WS13 == 2 | WS13 == 4), 100, 0),
                    OonsiteemptiedHHpit = ifelse(onsite == 2 & WS13 == 5, 100, 0),
                    Oonsiteemptiedother = ifelse(onsite == 2 & WS13 == 6, 100, 0),
                    OonsiteemptiedDK = ifelse(onsite == 1 & WS13 == 8, 100, 0),
                    Oonsiteneveremptied = ifelse(onsite == 2 & WS12 == 4, 100, 0),
                    OonsiteDKemptied = ifelse(onsite == 2 & WS12 >= 8, 100, 0))



hh = hh %>% mutate(safedisposal = ifelse(septicemptiedpit == 100 | septicneveremptied == 100 | septicDKemptied == 100 | Oonsiteemptiedpit == 100 |
                                           Oonsiteneveremptied == 100 | OonsiteDKemptied == 100, 100, 0),
                   unsafedisposal = ifelse(septicemptiedHHpit == 100 | septicemptiedother == 100 | OonsiteemptiedHHpit == 100 |
                                             Oonsiteemptiedother == 100, 100, 0),
                   treatment = ifelse(septicemptiedproviderplant == 100 | septicemptiedproviderDK == 100 | septicemptiedDK == 100 | 
                                        Oonsiteemptiedproviderplant == 100 | OonsiteemptiedproviderDK == 100 | OonsiteemptiedDK == 100, 100, 0))



##########


hh = hh %>% mutate(connectedsewer = ifelse(WS11 == 11 | WS11 == 18, 100, 0),
                   usingimproved = ifelse(WS11 %in% c(14, 23, 41, 51, 96), 100, 0),
                   opendefecation = ifelse(WS11 == 95, 100, 0),
                   missingx = ifelse(WS11 > 97, 100, 0))
```

# WS 3.5

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav"))

source(here("R/drinkingWater.R"))

ch <- read_sav(here("Data/ch.sav"))


hh <- hh %>% left_join(ch, by = c("HH1", "HH2")) %>% filter(UF17 == 1, UB2 < 3)

hh = hh %>% mutate(stools = ifelse(CA31 %in% 1:2, 100, 0),
                   disposalplace = ifelse(CA31 == 98, 99, CA31))
```

# WS 3.6

``` r
hh <- read_sav(here("Data/Tunisia_hh.sav"))
hh <- hh %>% filter(HH46 == 1) %>% 
  mutate(hhweightHH48 = HH48 * hhweight) %>% mutate(nhhmem = 1 * hhweightHH48)

var_lab(hh$nhhmem) = "Number of household members"; 
val_lab(hh$nhhmem) = make_labels("
1                        ")



source(here("R/drinkingWater.R"))




hh = hh %>% mutate(drinkingLayer = 0)

hh = hh %>% mutate(drinking = drinkingWater + 1) %>% 
  mutate(drinking = ifelse(WS1 %in% 11:12, 1,
                           ifelse(WS1 %in% c(61, 71) & WS4 <= 30, 1,
                                  ifelse(WS1 %in% c(13:14, 21, 31, 41, 51) & (WS3 %in% 1:2 | WS4 <= 30), 1,
                                         ifelse(WS1 %in% 91:92 & WS2 %in% 11:12, 1,
                                                ifelse(WS1 %in% 91:92 & (WS2 %in% c(61, 71) & WS4 <= 30), 1,
                                                       ifelse(WS1 %in% 91:92 & WS2 %in% c(13,14,21,31,41,51) & (WS3 %in% 1:2 | WS4 <= 30), 1,
                                                              ifelse(WS1 == 81, 4, drinking))))))))

var_lab(hh$drinking) = "Drinking Water"





hh = hh %>% mutate(sanitation = toiletType + 1) %>% 
  mutate(sanitation = ifelse(toiletType == 1 & sharedToilet == 0, 1, sanitation))

var_lab(hh$sanitation) = "Sanitation"

hh = hh %>% mutate(handwashing = 4) %>% 
  mutate(handwashing = ifelse(HW1 <= 3, 2,
                              ifelse(HW1 == 4, 3,
                                     ifelse(HW1 <= 4 & (HW2 == 1 & (HW7A == "A" | HW7B == "B")), 1, handwashing))))



hh = hh %>% mutate(basictotal = ifelse(drinking == 1 & sanitation == 1 & handwashing == 1, 100, 0))
```

# WS 4.1

``` r
wm = read_sav(here("Data/Tunisia_wm.sav"))

names(wm) = sapply(names(wm), tolower)



##### end commonVarswm.sav


wm = wm %>% filter(wm17 == 1, !is.na(un16))


# wmweight - weight data

wm = wm %>% mutate(numWomen = 1 * wmweight) %>% 
  mutate(amaterialre = ifelse(un19 == 1, 100, 0),
         amaterialnonre = ifelse(un19 == 2, 100, 0),
         amaterialDKmissing = ifelse(un19 >= 8, 100, 0),
         materialother = ifelse(un18 == 2, 100, 0),
         materialDK = ifelse(un18 >=8, 100, 0),
         appropriatematerial = ifelse(un18 == 1, 100, 0),
         privateplace = ifelse(un17 == 1, 100, 0),
         totalprct = 100,
         materialprivateplace = ifelse(privateplace == 100 & un18 == 1, 100, 0),
         layer0 = 0, 
         layer1 = 0)
```

# WS 4.2

``` r
wm = read_sav(here("Data/Tunisia_wm.sav"))


source(here("R/commonVarsWM.R"))

wm = wm %>% filter(wm17 == 1, !is.na(un16)) %>% mutate(numWomen = 1 * wmweight) %>% 
  mutate(noparticipation = ifelse(un16 == 1, 100, 0))
```
